---
title: "SurveyData"
author: "Brad"
date: "January 12, 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
 library(Mar.datawrangling)
 library(Mar.bycatch)
 library(tidyverse)

datadir="C:/Users/harperd/Documents/Halibut/RDataVault"
wd="C:/Users/harperd/Documents/Halibut/GitDataInputs/DataInputs/"
source(file.path(wd, ".passwords"))

```

## Update data from database 

```{r}

# Update data from database 
#get_data(db='isdb',data.dir=datadir,fn.oracle.username = uid, fn.oracle.password = pwd, fn.oracle.dsn = 'ptran',usepkg='roracle',force.extract=T)

get_data("isdb", data.dir = "C:/Users/harperd/Documents/Halibut/RDataVault/")
 
```

### SUrvey ABundance Indices
## prepare Data for hook occupancy model

```{r }
PrepareDataHookModel()


```

### Size Composition 
## Prepare data for Length Frequemcy plots

```{r pressure, echo=FALSE}
FixedSurvey<-FixedSurveyData()
RandomSurvey<-RandomSurveyData()
ComIndex<-CommercialIndexData()
```

## Fixed LF plots
```{r}
        

  # Construct CLF
  nafos<-unique(FixedSurvey$NAFAREA_ID)
  nafo4x <- nafos[c(grep('4X',nafos),grep('4V',nafos),grep('4W',nafos))]
  FixedSurvey4X <-subset(FixedSurvey,NAFAREA_ID%in%nafo4x)



  fixedLF=list()
  bins = paste0("L",seq(10,230,5))
  FixedSurvey$N_MEASURED <- rowSums(FixedSurvey[,bins])
  Yrs = 2009:2020
  sx = c(1,2,0)

  for(i in 1:length(Yrs)){
    
      #x=subset(FixedSurvey,YEAR==Yrs[i])
      #x$scaler = x$NUM_HOOK_HAUL/1000 
      fixedLF[[i]]=t(sapply(sx,function(s){colSums(subset(FixedSurvey,YEAR==Yrs[i]&SEXCD_ID==s,bins),na.rm=T)}))
      
      #fixedLF[[i]]=sapply(Yrs,colSums(subset(FixedSurvey,YEAR==Yrs[i],bins),na.rm=T)
    
  }
  
  #fixedLF=t(sapply(Yrs,function(y){colSums(subset(FixedSurvey,YEAR==y,bins),na.rm=T)}))
  names(fixedLF) = Yrs
  BarPlotLF(fixedLF,yrs=Yrs,rel=T,filen=file.path(wd,"figures","fixed4XLF1"))
  BarPlotLF(fixedLF,yrs=Yrs,rel=F,filen=file.path(wd,"figures","fixed4VWXLF2"),ymax=300)

```


## Random LF plots
```{r}
            # Construct CLF
            RandomLF=list()
            bins = paste0("L",seq(10,230,5))
            Yrs = 2017:2020
            sx = c(1,2,0)

            for(i in 1:length(Yrs)){
              
                #x=subset(FixedSurvey,YEAR==Yrs[i])
                #x$scaler = x$NUM_HOOK_HAUL/1000 
                RandomLF[[i]]=t(sapply(sx,function(s){colSums(subset(RandomSurvey,YEAR==Yrs[i]&SEXCD_ID==s,bins),na.rm=T)}))
                
                #fixedLF[[i]]=sapply(Yrs,colSums(subset(FixedSurvey,YEAR==Yrs[i],bins),na.rm=T)
              
            }
            
            #fixedLF=t(sapply(Yrs,function(y){colSums(subset(FixedSurvey,YEAR==y,bins),na.rm=T)}))
            names(RandomLF) = Yrs
            BarPlotLF(RandomLF,yrs=Yrs,rel=T,filen=file.path(wd,"figures","randomLF1"))
            BarPlotLF(RandomLF,yrs=Yrs,rel=F,filen=file.path(wd,"figures","randomLF2"),ymax=150)

```

## Checking data for mis match in EST_NUM_CAUGHT and NUM_MEASURED

```{r}

SR20=subset(RandomSurvey,NUM_MEASURED!=EST_NUM_CAUGHT&YEAR==2020)

#FS20=subset(FixedSurvey, NUM_MEASURED!=EST_NUM_CAUGHT&YEAR==2020) 
##maybe they don't have to measure all ones caught in the fixed survey stations?

SR20 <- SR20 %>%
  select("FISHSET_ID", "SET_NO", "TRIP_ID", "STATION", "EST_NUM_CAUGHT", "EST_COMBINED_WT", "SEXCD_ID", "NUM_MEASURED", "TRIP", "VESS_ID", "VESSEL_NAME", "CFV")
print(SR20)

```

Checking length against weight for random survey halibut


```{r}
halibut <- ISSETPROFILE_WIDE %>%
  filter(YEAR == 2020) %>%
  left_join(ISFISHSETS, by = "FISHSET_ID")%>%
  filter(SETCD_ID == 5) %>%
  left_join(ISCATCHES, by = "FISHSET_ID") %>%
  filter(SPECCD_ID == 30) %>%
  left_join(ISFISH, by = "CATCH_ID")

halibut$SEXCD_ID <- as.character(halibut$SEXCD_ID)

ggplot(halibut, aes(x=FISH_LENGTH, fill=SEXCD_ID, color=SEXCD_ID)) +
  geom_histogram(binwidth = 1, position="identity", alpha=0.5) +
  theme_classic()
```

