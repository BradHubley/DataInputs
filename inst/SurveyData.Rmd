---
title: "SurveyData"
author: "Brad"
date: "January 12, 2021"
output: html_document
---

```{r setup, include=FALSE}
library(devtools)
#install_github("Maritimes/Mar.datawrangling")
#install_github("Maritimes/Mar.bycatch")
 library(Mar.datawrangling)
 library(Mar.bycatch)
 library(tidyverse)

datadir="C:/Users/hubleyb/Documents/Halibut/data"
wd="C:/Users/hubleyb/Documents/Halibut/git/DataInputs"
source(file.path(wd,".passwords"))

```

## Update data from database 

```{r}

# Update data from database 
get_data(db='isdb',data.dir=datadir,fn.oracle.username = uid, fn.oracle.password = pwd, fn.oracle.dsn = 'ptran',usepkg='roracle',force.extract=T)
 
```

### SUrvey ABundance Indices
## prepare Data for hook occupancy model

```{r }
PrepareDataHookModel()


```

### Size Composition 
## Prepare data for Length Frequemcy plots

```{r, echo=FALSE}
bins=seq(5,260,5)

FixedSurvey<-FixedSurveyData()
RandomSurvey<-RandomSurveyData()
ComIndex<-CommercialIndexData()
```

## Construct LF for plots
```{r}
        
  #subset by nafo
  #nafos<-unique(FixedSurvey$NAFAREA_ID)
  #nafo4x <- nafos[c(grep('4X',nafos),grep('4V',nafos),grep('4W',nafos))]
  #FixedSurvey4X <-subset(FixedSurvey,NAFAREA_ID%in%nafo4x)
  
  #scale LF
  #FixedSurvey$N_MEASURED <- rowSums(FixedSurvey[,bins])
  #x$scaler = x$NUM_HOOK_HAUL/1000 

  # Construct CLF
  fixedLF=constructLF(LFdata=FixedSurvey,bins=bins, Yrs = 2009:2020)
  RandomLF=constructLF(LFdata=RandomSurvey,bins=bins, Yrs = 2017:2020)
  ComIndexLF=constructLF(LFdata=ComIndex,bins=bins, Yrs = 2009:2020)
  

```


## LF plots
```{r}
  
    BarPlotLF(fixedLF,yrs=Yrs,rel=T,filen=file.path(wd,"figures","fixedLF1"))
    BarPlotLF(fixedLF,yrs=Yrs,rel=F,filen=file.path(wd,"figures","fixedLF2"),ymax=320)
  
    BarPlotLF(RandomLF,yrs=Yrs,rel=T,filen=file.path(wd,"figures","randomLF1"))
    BarPlotLF(RandomLF,yrs=Yrs,rel=F,filen=file.path(wd,"figures","randomLF2"),ymax=150)

```

## Checking data for mis match in EST_NUM_CAUGHT and NUM_MEASURED

```{r}

RandomSurvey$N_MEASURED <- rowSums(RandomSurvey[,paste0("L",bins[-1])])
x20=subset(RandomSurvey,NUM_MEASURED!=EST_NUM_CAUGHT&YEAR==2020)


```

