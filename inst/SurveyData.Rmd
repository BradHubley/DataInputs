---
title: "SurveyData"
author: "Brad"
date: "January 12, 2021"
output: html_document
---

```{r setup, include=FALSE}
library(devtools)
#install_github("Maritimes/Mar.datawrangling")
#install_github("Maritimes/Mar.bycatch")
 library(Mar.datawrangling)
 library(Mar.bycatch)
 library(tidyverse)

source(file.path(getwd(), "directories.r"))
#datadir="C:/Users/hubleyb/Documents/Halibut/data"
#wd="C:/Users/hubleyb/Documents/Halibut/Git/DataInputs/"
#datadir="C:/Users/harperd/Documents/Halibut/RDataVault"
#wd="C:/Users/harperd/Documents/Halibut/GitDataInputs/DataInputs/"
source(file.path(wd, "passwords.r"))



```

## Update data from database 

```{r}

# Update data from database 
#ds_all <- load_datasources()

#get_data(db='isdb',data.dir=datadir,fn.oracle.username = uid, fn.oracle.password = pwd, fn.oracle.dsn = 'ptran',usepkg='roracle',force.extract=T)

get_data(db='isdb',data.dir=datadir,fn.oracle.username = uid, fn.oracle.password = pwd, fn.oracle.dsn = 'ptran',usepkg='roracle',force.extract=T)
get_data(db='rv',data.dir=datadir,fn.oracle.username = uid, fn.oracle.password = pwd, fn.oracle.dsn = 'ptran',usepkg='roracle',force.extract=T)

get_data_custom(schema="observer", data.dir = datadir, tables = c("ISFISHLENGTHS","ISSAMPLES"), usepkg = "roracle",
                                     fn.oracle.dsn= "PTRAN", fn.oracle.username=uid, fn.oracle.password =pwd)
```

### SUrvey ABundance Indices
## prepare Data for hook occupancy model

```{r }
HookOccupancyData<-PrepareDataHookModel()

```

### Size Composition 
## Prepare data for Length Frequemcy plots

```{r, echo=FALSE}
bins=seq(0,260,5)

FixedSurvey<-FixedSurveyData(datadir=datadir,by.sex=T, bins=bins, LF.from = "ISFISH")
FixedSurvey2<-FixedSurveyData(datadir=datadir,by.sex=T, bins=bins, LF.from = "ISFISHLENGTHS")

RandomSurvey<-RandomSurveyData(sp=30,datadir=datadir,add.gear=T,add.LF=T,bins=bins,by.sex=T,hook.data=T)
RandomSurvey2<-RandomSurveyData(sp=30,datadir=datadir,add.LF=T,bins=bins,by.sex=F)

ComIndex<-CommercialIndexData(datadir=datadir,bins=bins,add.portsampling=T)
```

## Map Fixed stations
```{r}
xl=c(-69,-47)
yl=c(40,48)    
stations_100 <- read.csv(file.path(wd,'data',"FixedStation100.csv"))

  pdf(file.path(wd,'figures','FixedStationSurveyMap.pdf'),width=10,height=7)
                         
SpatialHub::bioMap(xlim = xl, ylim = yl, mapRes="MR", title = "Fixed Station Survey")
points(LATITUDE~LONGITUDE,FixedSurvey2,pch=16,col=rgb(0,0,0,0.2),cex=0.5)
points(lat.DecDeg~lon.DecDeg,stations_100,pch=21,bg=rgb(1,1,0,0.8))

dev.off()



```

## Map Random stations
```{r}
xl=c(-69,-47)
yl=c(40,48)    
#stations_100 <- read.csv(file.path(wd,'data',"FixedStation100.csv"))

  pdf(file.path(wd,'figures','StratfiedRandomSurveyMap2020.pdf'),width=10,height=7)
                         
SpatialHub::bioMap(xlim = xl, ylim = yl, mapRes="MR", title = "Fixed Station Survey")
points(LATITUDE~LONGITUDE,subset(RandomSurvey2,YEAR==2020),pch=21,bg=rgb(1,1,0,1))

dev.off()



```


## Checking difference between ISFISHLENGTHS and ISFISH
```{r}
#sum(abs(FixedSurvey2[,paste0("L",seq(10,260,5))]-FixedSurvey[,paste0("L",seq(10,260,5))]),na.rm=T)
#sum(FixedSurvey2[,paste0("L",seq(10,260,5))],na.rm=T)
#sum(FixedSurvey[,paste0("L",seq(10,260,5))],na.rm=T)

#FixedSurvey2020_2 <- subset(FixedSurvey2,YEAR==2020)
#FixedSurvey2020 <- subset(FixedSurvey,YEAR==2020)

#FixedSurvey2020[rowSums(abs(FixedSurvey2020_2[,paste0("L",seq(10,260,5))]-FixedSurvey2020[,paste0("L",seq(10,260,5))]),na.rm=T)>0,]


#subset(FixedSurvey,TRIP=="J20-0019"&SET_NO==2)
#subset(FixedSurvey2,TRIP=="J20-0019"&SET_NO==2)
#subset(isdb$ISFISH,CATCH_ID==101911351&SEXCD_ID==0)


LFcheck<-checkLF(datadir=datadir)

subset(LFcheck,!MATCH&YEAR==2020&SETCD_ID==5)
subset(HALIBUTSURVEY,!MATCH&YEAR==2020&TRIP=="J20-0020A"&SETCD_ID%in%4:5)
subset(LFcheck,!MATCH&YEAR==2020&SETCD_ID==5&!is.na(SMPL_ID))


 sum(subset(LFcheck,YEAR==2020&SETCD_ID==5)$ISFISH_COUNT)

 sum(subset(LFcheck,YEAR==2020&SETCD_ID==5)$NUM_AT_LENGTH)
 
 sum(subset(LFcheck,SETCD_ID==5)$ISFISH_COUNT)
 sum(subset(LFcheck,SETCD_ID==5)$NUM_AT_LENGTH)
 sum(subset(LFcheck,SETCD_ID==4)$ISFISH_COUNT)
 sum(subset(LFcheck,SETCD_ID==4)$NUM_AT_LENGTH)
 sum(subset(LFcheck,SETCD_ID==10)$ISFISH_COUNT)
 sum(subset(LFcheck,SETCD_ID==10)$NUM_AT_LENGTH)
 

```
## Checked a few differences in the data sheets and they persisted on the page, i.e. length frequency form was inconsistant with halibut survey tagging observations. There are more fish observed in ISFISHLENGTHS so go with that for size composition. 

# checking for duplicate stations
```{r}
FixedSurvey2<-FixedSurveyData(datadir=datadir,by.sex=F)
FixedSurvey2$SY <- paste0(FixedSurvey2$YEAR,FixedSurvey2$STATION)
dr<-subset(FixedSurvey2,duplicated(SY))
fsdups<-subset(FixedSurvey2,SY%in%dr$SY)
fsdups
RandomSurvey2<-RandomSurveyData(datadir=datadir,by.sex=F)
RandomSurvey2$SY <- paste0(RandomSurvey2$YEAR,RandomSurvey2$STATION)
dr<-subset(RandomSurvey2,duplicated(SY))
fsdups<-subset(RandomSurvey2,SY%in%dr$SY)
fsdups
```

## Construct LF for plots
```{r}
        
  #subset by nafo
  #nafos<-unique(FixedSurvey$NAFAREA_ID)
  #nafo4x <- nafos[c(grep('4X',nafos),grep('4V',nafos),grep('4W',nafos))]
  #FixedSurvey4X <-subset(FixedSurvey,NAFAREA_ID%in%nafo4x)
  
  #scale LF
  #FixedSurvey$N_MEASURED <- rowSums(FixedSurvey[,bins])
  #x$scaler = x$NUM_HOOK_HAUL/1000 

  # Construct CLF
  fixedLF=constructLF(LFdata=FixedSurvey,bins=bins, Yrs = 2009:2020)
  fixedLF2=constructLF(LFdata=FixedSurvey2,bins=bins, Yrs = 2009:2020)
  RandomLF=constructLF(LFdata=RandomSurvey,bins=bins, Yrs = 2017:2020)
  ComIndexLF=constructLF(LFdata=ComIndex,bins=bins, Yrs = 2009:2020)

  

```


## LF plots
```{r}
  Yrs = 2009:2020

    BarPlotLF(fixedLF,yrs=Yrs,rel=T,filen=file.path(wd,"figures","fixedLF1"))
    BarPlotLF(fixedLF2,yrs=Yrs,rel=T,filen=file.path(wd,"figures","fixedLF2"))
    BarPlotLF(fixedLF,yrs=Yrs,rel=F,filen=file.path(wd,"figures","fixedLF"),ymax=320)
  
    BarPlotLF(RandomLF,yrs=Yrs,rel=T,filen=file.path(wd,"figures","randomLF1"))
    BarPlotLF(RandomLF,yrs=Yrs,rel=F,filen=file.path(wd,"figures","randomLF2"),ymax=150)
    
    BarPlotLF(ComIndexLF,yrs=2009:2020,rel=T,filen=file.path(wd,"figures","comindexLF1"))
    BarPlotLF(ComIndexLF,yrs=2009:2020,rel=F,filen=file.path(wd,"figures","comindexLF2"),ymax=1400)


```


```{r}

FixedSurvey<-FixedSurveyData(datadir=datadir,by.sex=T, bins=bins, LF.from = "ISFISH",correct.splitsets = F)
FixedSurvey2<-FixedSurveyData(datadir=datadir,by.sex=T, bins=bins, LF.from = "ISFISHLENGTHS",correct.splitsets = F)

  Yrs = 2009:2020

  fixedLF=constructLF(LFdata=FixedSurvey,bins=bins, Yrs = Yrs)
  fixedLF2=constructLF(LFdata=FixedSurvey2,bins=bins, Yrs = Yrs)

      BarPlotLF(fixedLF,yrs=Yrs,rel=T,filen=file.path(wd,"figures","fixedLF3"))
    BarPlotLF(fixedLF2,yrs=Yrs,rel=T,filen=file.path(wd,"figures","fixedLF4"))
    
    
  HALIBUTSURVEY<- FixedSurvey 
    
  HALIBUTSURVEY$SY <- paste0(HALIBUTSURVEY$YEAR,HALIBUTSURVEY$STATION,HALIBUTSURVEY$SEXCD_ID)
  dr<-subset(HALIBUTSURVEY,duplicated(SY))

  fsdups<-subset(HALIBUTSURVEY,SY%in%dr$SY)

  newd<-fsdups %>%
    group_by(YEAR,STATION,VESS_ID,SEXCD_ID ) %>%
    summarise(SOAKMINP3P1=sum(SOAKMINP3P1),NUM_HOOK_HAUL=sum(NUM_HOOK_HAUL),across(EST_NUM_CAUGHT:NUM_MEASURED, sum, na.rm=T)) %>%
    right_join(.,dplyr::select(dr,YEAR,STATION,which(!names(dr)%in%names(.)))) %>%
    filter(!duplicated(SY)) %>%
    data.frame()

  HALIBUTSURVEY <- left_join(subset(HALIBUTSURVEY,!duplicated(SY)),newd)
  fixedLF=constructLF(LFdata=HALIBUTSURVEY,bins=bins, Yrs = Yrs)
      BarPlotLF(fixedLF,yrs=Yrs,rel=T,filen=file.path(wd,"figures","fixedLF5"))

```

## Checking data for mis match in EST_NUM_CAUGHT and NUM_MEASURED

```{r}


SR20=subset(RandomSurvey,NUM_MEASURED!=EST_NUM_CAUGHT&YEAR==2020)

#FS20=subset(FixedSurvey, NUM_MEASURED!=EST_NUM_CAUGHT&YEAR==2020) 
##maybe they don't have to measure all ones caught in the fixed survey stations?

RandomSurvey$N_MEASURED <- rowSums(RandomSurvey[,paste0("L",bins[-1])])
x20=subset(RandomSurvey,NUM_MEASURED!=EST_NUM_CAUGHT&YEAR==2020)


SR20 <- SR20 %>%
  select("FISHSET_ID", "SET_NO", "TRIP_ID", "STATION", "EST_NUM_CAUGHT", "EST_COMBINED_WT", "SEXCD_ID", "NUM_MEASURED", "TRIP", "VESS_ID", "VESSEL_NAME", "CFV")
print(SR20)
```
## LF plots
```{r}
  
    BarPlotLF(fixedLF,yrs=Yrs,rel=T,filen=file.path(wd,"figures","fixedLF1"))
    BarPlotLF(fixedLF,yrs=Yrs,rel=F,filen=file.path(wd,"figures","fixedLF2"),ymax=320)
  
    BarPlotLF(RandomLF,yrs=Yrs,rel=T,filen=file.path(wd,"figures","randomLF1"))
    BarPlotLF(RandomLF,yrs=Yrs,rel=F,filen=file.path(wd,"figures","randomLF2"),ymax=150)
    
    BarPlotLF(ComIndexLF,yrs=2009:2020,rel=T,filen=file.path(wd,"figures","comindexLF1"))
    BarPlotLF(ComIndexLF,yrs=2009:2020,rel=F,filen=file.path(wd,"figures","comindexLF2"),ymax=1400)


```

Checking length against weight for random survey halibut


```{r}
halibut <- ISSETPROFILE_WIDE %>%
  filter(YEAR == 2020) %>%
  left_join(ISFISHSETS, by = "FISHSET_ID")%>%
  filter(SETCD_ID == 5) %>%
  left_join(ISCATCHES, by = "FISHSET_ID") %>%
  filter(SPECCD_ID == 30) %>%
  left_join(ISFISH, by = "CATCH_ID")

halibut$SEXCD_ID <- as.character(halibut$SEXCD_ID)

ggplot(halibut, aes(x=FISH_LENGTH, fill=SEXCD_ID, color=SEXCD_ID)) +
  geom_histogram(binwidth = 1, position="identity", alpha=0.5) +
  theme_classic()
```


## RV survey

```{r}
get_data(db='rv',data.dir=datadir)
RandomSurvey$N_MEASURED <- rowSums(RandomSurvey[,paste0("L",bins[-1])])
x20=subset(RandomSurvey,NUM_MEASURED!=EST_NUM_CAUGHT&YEAR==2020)


```

## RV survey

```{r}
get_data(db='rv',data.dir=datadir)


```

