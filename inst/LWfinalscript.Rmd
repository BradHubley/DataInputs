---
title: "LWfinal"
author: "Danni Harper"
date: "9/16/2021"
output: html_document
---

---packages and data directory set up
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
 library(Mar.datawrangling)
 library(tidyverse)
 library(lubridate)
 library(stringr)


datadir="C:/Users/harperd/Documents/Halibut/RDataVault"
wd="C:/Users/harperd/Documents/Halibut/GitDataInputs/DataInputs/"
source(file.path(wd, "passwords.r"))
```

---Extract MAR RV survey data using RORACLE
```{r}
#get_data("rv", data.dir = "C:/Users/harperd/Documents/Halibut/RDataVault/", usepkg = "roracle",fn.oracle.username = "danni.harper@dfo-mpo.gc.ca", fn.oracle.password = "DrDs1994!", fn.oracle.dsn = "PTRAN", force.extract = T)
```

Extract MAR RV survey data from existing dump
```{r}
get_data("rv", data.dir = datadir)
```

Pull halibut morphology data from the MAR RV survey since beginning of survey data set (1970?)
```{r}
hal <- GSDET %>%
  filter(SPEC == "30")
```

Scatter plot of Length and Weight of halibut from RV survey
```{r}
ggplot(hal, aes(FLEN, FWT)) +
  geom_point()
```
There are 1188 fish that have no weights associated with the lengths in the MAR RV survey data

Combining the hal data with the set info to determine strata
```{r}
setdata_halRV <- merge(hal, GSINF, by.x = c("MISSION","SETNO"), 
                       by.y = c("MISSION","SETNO"), all.x = TRUE, all.y = FALSE) %>% 
  dplyr::select("MISSION", "SETNO", "SPEC", "FSHNO", "FLEN", "FSEX", "FMAT", "FWT", "AGMAT", "AGE", "CLEN", "REMARKS.x", "SIZE_CLASS", "SDATE", "STRAT", "SLAT", "SLONG", "ELAT", "ELONG", "ETIME", "REMARKS.y", "START_DEPTH", "END_DEPTH", "SURFACE_TEMPERATURE", "BOTTOM_TEMPERATURE", "BOTTOM_SALINITY", "STATION")
```

Joining the Stratum table to attach associated NAFO info
```{r}
setdata_halRV <- setdata_halRV %>%
  left_join(GSSTRATUM, by = "STRAT") %>%
  dplyr::select(-"DMIN", -"DMAX", -"AREA", -"DEPTH")
```

Create year column and column of 5yr bins starting in 1970
```{r}
setdata_halRV <- setdata_halRV %>%
  mutate(YEAR = substr(SDATE, 1,4)) %>%
      filter(SDATE <= as.Date("2021-01-01"))

setdata_halRV <- setdata_halRV %>%
  mutate(yr_bin = 
           ifelse(YEAR %in% c(1970, 1971, 1972, 1973, 1974, 1975), "1970-1975", 
           ifelse(YEAR %in% c(1976, 1977, 1978, 1979, 1980), "1976-1980",
           ifelse(YEAR %in% c(1981, 1982, 1983, 1984, 1985), "1981-1985", 
           ifelse(YEAR %in% c(1986, 1987, 1988, 1989, 1990), "1986-1990",
           ifelse(YEAR %in% c(1991, 1992, 1993, 1994, 1995), "1991-1995",
           ifelse(YEAR %in% c(1996, 1997, 1998, 1999, 2000), "1996-2000",
           ifelse(YEAR %in% c(2001, 2002, 2003, 2004, 2005), "2001-2005",
           ifelse(YEAR %in% c(2006, 2007, 2008, 2009, 2010), "2006-2010",
           ifelse(YEAR %in% c(2011, 2012, 2013, 2014, 2015), "2011-2015",
           ifelse(YEAR %in% c(2016, 2017, 2018, 2019, 2020), "2016-2020", "Error")))))))))))

```


See NAFO zones represented in the hal data from the Mar RV survey data
```{r}
unique(setdata_halRV$NAME)
```
There are 10 fish where there is no corresponding NAFO (can likely just look it up using the coordinates?)

Reducing the fine scale of NAFO regions to the larger zones (e.g. 4Vs to 4V...) in new column NAFO
```{r}
setdata_halRV <- setdata_halRV %>%
  mutate(NAFO = substr(NAME, 1, 2))
```

Graphing the length by weight by larger NAFO zone
```{r}
ggplot(setdata_halRV, aes(FLEN, FWT)) +
  geom_point()+
  facet_wrap(~NAFO)
```

Checking how many fish sampled by year and NAFO
```{r}
NAFO_4_5 <- setdata_halRV %>%
  mutate(NAFO = substr(NAFO,1,1))


num_fish_sampled <- data.frame(table(NAFO_4_5$YEAR, NAFO_4_5$NAFO))

#this counts how many fish are in "numb_fish_sampled"
sum(num_fish_sampled$Freq)
```
There are 10 fewer fish in num_fish_sampled than in setdata_RVhal because 10 fish in the original data don't have an associated NAFO zone

Many of these don't match up for NAFO and year...(how is the data so different?)

Looking at the 1188 missing data...
```{r}
setdata_halRV[is.na(setdata_halRV$FLEN),]

setdata_halRV[is.na(setdata_halRV$FWT),] #there are 1188 fish missing weights
```


---Extract ISDB data using RORACLE
```{r}
get_data("isdb", data.dir = "C:/Users/harperd/Documents/Halibut/RDataVault/", usepkg = "roracle",fn.oracle.username = "", fn.oracle.password = "", fn.oracle.dsn = "PTRAN", force.extract = T)
```

Pull ISDB data from where it is stored locally (previously pulled from database using oracle)
```{r}
get_data("isdb", data.dir = datadir)
```

#----Pull all halibut from ISDB, not just ones from halibut directed trips and until 2020----

```{r}
hal_allcatch <- ISCATCHES %>%
  filter(SPECCD_ID == "30")
```

```{r}
hal_all <- hal_allcatch %>%
    filter(CREATED_DATE <= as.Date("2021-01-01"))%>%
  left_join(ISFISH, by = "CATCH_ID")

unique(hal_all$SPECCD_ID)

hal_all %>% count(SPECCD_ID)
```
Removing rows without length/weight data
```{r}
hal_all %>% count(FISH_LENGTH) # 93,161 observations without length
hal_allrmNAwt <- hal_all %>%
  drop_na(FISH_WEIGHT) #goes from 272,023 observations to 55,197 when weight=NA is removed

hal_allrmNAwt %>% count(FISH_LENGTH) #only 2 fish where there is a weight and no length

```
Finding how/when these halibut were caught by isolating the sets and trips where they were caught
```{r}
hal_allsets <- hal_allrmNAwt %>%
  left_join(ISFISHSETS, by = "FISHSET_ID")

hal_allLATLONG <- ISSETPROFILE_WIDE %>% dplyr::select(FISHSET_ID, LAT1, LONG1, LAT2, LONG2, LAT3, LONG3, LAT4, LONG4)
  
hal_allsetinfo <- hal_allsets %>%
  left_join(hal_allLATLONG, by = "FISHSET_ID")

hal_alltrips <- hal_allsetinfo %>%
  left_join(ISTRIPS, by = "TRIP_ID")

```

Removing the port sampled data (weights not measured with consistent methods)
```{r}
hal_alltrips <- hal_alltrips %>%
  filter(TRIPCD_ID != "7058")
```
Looking at the different types of trips
```{r}
hal_alltrips %>% count(TRIPCD_ID)

trips_halcaught <- hal_alltrips %>%
  left_join(ISTRIPTYPECODES, by = "TRIPCD_ID") %>%
  dplyr::select("TRIPCD_ID", "TRIP_TYPE") %>%
  count(TRIPCD_ID, TRIP_TYPE)
```

Trimming down the dataframe to useful columns
```{r}
hal_alltrips <- hal_alltrips %>%
  dplyr::select("TRIP_ID", "TRIP", "TRIPCD_ID", "VESS_ID", "LICENSE_NO", "BOARD_DATE", "LANDING_DATE", "FISHSET_ID", "SET_NO", "SETCD_ID", "NAFAREA_ID", "CATCH_ID", "SPECCD_ID", "FISH_ID", "FISH_NO", "SEXCD_ID", "FISH_LENGTH", "FISH_WEIGHT", "MATCD_ID", "COMMENTS", "LAT1", "LONG1", "LAT2", "LONG2", "LAT3", "LONG3", "LAT4", "LONG4")
```



Looking into the length and weight data
```{r}
summary(hal_alltrips$FISH_LENGTH)

summary(hal_alltrips$FISH_WEIGHT)
```

Creating some new useful columns
```{r}
hal_alltrips <- hal_alltrips %>%
  mutate(YEAR = substr(BOARD_DATE, 1,4))
  
hal_alltrips <- hal_alltrips %>%
  mutate(NAFO = substr(NAFAREA_ID, 1, 2))
```


Silver hake has the most measured halibut (more than the halibut commercial fishery) only from years 1980-1997, weight appears to be measured in kg and also in g...challenge. 
```{r}
SHhal <- hal_alltrips %>%
  filter(TRIPCD_ID == "14") %>%
  dplyr::select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE, YEAR, NAFO)
summary(SHhal)

ggplot(SHhal)+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT))+
  facet_wrap(~NAFO, scales = "free")
```

Removing data from outside our management unit (keeping 3NOP4VWX5YZ and NA)
```{r}
hal_allNAFOfilter <- hal_alltrips %>%
  filter(NAFO %in% c("3N", "3O", "3P", "4V", "4W", "4X", "5Y", "5Z", NA))

ggplot(hal_allNAFOfilter) +
  geom_histogram(aes(YEAR), stat = "count") +
  facet_wrap(~NAFO, scales = "free")
```

Difference in amount of data between all halibut in ISDB and all halibut from directed trips = 14,891 more halibut when considering all the data...although there are some limitations (unknown how these data are recorded, issues with units...)

#----Data exploration----
```{r}

ISDB_halall <- hal_allNAFOfilter %>%
  drop_na(SEXCD_ID) %>%
  drop_na(FISH_LENGTH) %>%
  drop_na(FISH_WEIGHT) %>%
  drop_na(NAFO)

MarRV <- setdata_halRV %>%
  drop_na(FSEX) %>%
  drop_na(FLEN) %>%
  drop_na(FWT) %>%
  drop_na(NAFO)
```

Adding the gear info to the ISDB tables
```{r}
gear <- ISGEARS %>%
  dplyr::select(TRIP_ID, GEARCD_ID) 

ISDBhaltrips <- ISDB_halall %>%
  dplyr::select(TRIP_ID, TRIPCD_ID)

hal_gear <- ISDBhaltrips %>%
  left_join(gear, by = "TRIP_ID")

hal_gear <- hal_gear %>% count(TRIP_ID, GEARCD_ID)

n_occur <- data.frame(table(hal_gear$TRIP_ID))  %>% filter(Freq > 1) %>% rename(TRIP_ID = Var1)#47 trips where 2 types of gear are 

n_occur <- n_occur %>%
  dplyr::select(TRIP_ID) 

n_occur2 <- n_occur[,]

repeat_gear <- subset(hal_gear, TRIP_ID %in% n_occur2) #mostly all 12, 15 so both trawls (can make just trawl), then 1 trip with a HARPOONED halibut...is that possible?!
# ISDB_halall %>% filter(TRIP_ID == "5781")

hal_gear <- hal_gear  %>%
  mutate(GEARCD_ID = replace(GEARCD_ID, GEARCD_ID %in% c(7, 11, 12, 15, 16), "trawl")) %>%
  mutate(GEARCD_ID = replace(GEARCD_ID, GEARCD_ID %in% c(41), "gillnet")) %>%
  mutate(GEARCD_ID = replace(GEARCD_ID, GEARCD_ID %in% c(21, 22), "seine")) %>%
  mutate(GEARCD_ID = replace(GEARCD_ID, GEARCD_ID %in% c(50, 51), "longline")) %>%
  mutate(GEARCD_ID = replace(GEARCD_ID, GEARCD_ID == 71, "dredge")) %>%
  mutate(GEARCD_ID = replace(GEARCD_ID, GEARCD_ID == 81, "harpoon")) %>%
  rename(GEAR = GEARCD_ID) 


#For my purposes Im going to change the harpoon recording to longline (no way of knowing which fish(es) were harpooned)
hal_gear <- hal_gear %>%
  mutate(GEAR = replace(GEAR, GEAR == "harpoon", "longline")) %>%
  dplyr::select(TRIP_ID, GEAR) %>%
  distinct()

n_occur3 <- data.frame(table(hal_gear$TRIP_ID)) %>% filter(Freq > 1)
hal_gear %>% count(TRIP_ID)


#bringing gear into my final tables
ISDB_halall <- ISDB_halall %>%
  left_join(hal_gear, by = "TRIP_ID")
```

Bring RV and ISDB together: making new columns and removing some columns in the rv survey data
```{r}
MarRV$REMARKS <- paste(MarRV$REMARKS.x, MarRV$REMARKS.y, sep=",")

MarRV <- MarRV %>%
  mutate(GEAR = "trawl") %>%
  mutate(TRIPCD_ID = "RV") %>%
  mutate(TYPE = "RV") %>%
  dplyr::select(-"FMAT", -"AGMAT", -"AGE", -"CLEN", -"SIZE_CLASS", -"ETIME", -"START_DEPTH", -"END_DEPTH", -"SURFACE_TEMPERATURE",
         -"BOTTOM_TEMPERATURE", -"BOTTOM_SALINITY", -"STATION", -"REMARKS.x", -"REMARKS.y", -"STRAT") %>%
  rename("TRIP" = "MISSION", "SEXCD_ID" = "FSEX", "SET_NO" = "SETNO", "SPECCD_ID" = "SPEC", "FISH_NO" = "FSHNO", 
         "FISH_LENGTH" = "FLEN", "FISH_WEIGHT" = "FWT", "COMMENTS" = "REMARKS", "BOARD_DATE" = "SDATE", "LAT1" = "SLAT", 
         "LONG1" = "SLONG", "LAT2" = "ELAT", "LONG2" = "ELONG", "NAFAREA_ID" = "NAME")
```

Removing excess columns from ISDB datasets to merge with RV
```{r}
ISDBdat <- ISDB_halall %>%
  mutate(TYPE = "ISDB") %>%
  mutate(yr_bin = 
           ifelse(YEAR %in% c(1970, 1971, 1972, 1973, 1974, 1975), "1970-1975", 
           ifelse(YEAR %in% c(1976, 1977, 1978, 1979, 1980), "1976-1980",
           ifelse(YEAR %in% c(1981, 1982, 1983, 1984, 1985), "1981-1985", 
           ifelse(YEAR %in% c(1986, 1987, 1988, 1989, 1990), "1986-1990",
           ifelse(YEAR %in% c(1991, 1992, 1993, 1994, 1995), "1991-1995",
           ifelse(YEAR %in% c(1996, 1997, 1998, 1999, 2000), "1996-2000",
           ifelse(YEAR %in% c(2001, 2002, 2003, 2004, 2005), "2001-2005",
           ifelse(YEAR %in% c(2006, 2007, 2008, 2009, 2010), "2006-2010",
           ifelse(YEAR %in% c(2011, 2012, 2013, 2014, 2015), "2011-2015",
           ifelse(YEAR %in% c(2016, 2017, 2018, 2019, 2020), "2016-2020", "Error")))))))))))

ISDB_halall <- ISDBdat %>%
  dplyr::select(-"FISH_ID", -"TRIP_ID", -"VESS_ID", -"LICENSE_NO", -"LANDING_DATE", -"FISHSET_ID", -"SETCD_ID",
         -"CATCH_ID", -"MATCD_ID", -"LAT3", -"LONG3", -"LAT4", -"LONG4")
```

Merging the ISDB datasets with the RV dataset
```{r}
hal_datAll <- rbind(ISDB_halall, MarRV)
```

Identifying and removing the outliers from the overall dataset using A and B from previous assessment (created using Nell's A and B function)
```{r}
library(sqldf)

hal_datAll <- hal_datAll %>%
  mutate(id = row_number())

test_halAll <- hal_datAll %>%
  dplyr::select(id, FISH_LENGTH, FISH_WEIGHT, TRIP, TRIPCD_ID)

test_halAll$out<-0
test_halAll<-test_halAll[!is.na(test_halAll$FISH_LENGTH),]
test_halAll<-test_halAll[!is.na(test_halAll$FISH_WEIGHT),]

#identify outliers (using a and b from the previous assessment log(a)=-5.021354 so a=0.00659559; b=3.124184)
mod_outliers<-nls(FISH_WEIGHT~a*FISH_LENGTH^b,data=test_halAll,start=c(a=0.00659559,b=3.124184),na.action=na.omit) 

#these results are the same with a=0.001 and b=3 as was used by nell in her getLW function from the previous assessment
test_halAll$upper<-predict(mod_outliers, list(FISH_LENGTH = test_halAll$FISH_LENGTH))*1.75
test_halAll$lower<-predict(mod_outliers, list(FISH_LENGTH = test_halAll$FISH_LENGTH))*0.25
test_halAll$out[test_halAll$FISH_WEIGHT<test_halAll$upper&test_halAll$FISH_WEIGHT>test_halAll$lower]<-1
test_lenwt.dat.all<-test_halAll[,c(1:8)]

all_outliers <- test_lenwt.dat.all %>% filter(out == "0") #here we lose 326 fish as outliers (the overall dataset, it's 0.56%) 
test_full <- test_lenwt.dat.all %>% filter(out == "1") 

#bring test_full back together with the other df
test_full <- test_full %>%
  dplyr::select("id") %>%
  left_join(hal_datAll, by = "id")

test_full %>%
  filter(FISH_WEIGHT < 250) %>%
  ggplot(aes(FISH_LENGTH, FISH_WEIGHT))+
  geom_point()
#the problem seen above where issues arose due to kg vs. g units is not seen here, these data seem cleaned

ggplot(test_full, aes(FISH_LENGTH, FISH_WEIGHT))+
  geom_point()

hal_datOR <- test_full

# test_full %>% filter(between(FISH_LENGTH, 175, 200), between(FISH_WEIGHT, 20000, 21000)) %>%
# ggplot(aes(FISH_LENGTH, FISH_WEIGHT, label=TRIP))+
#   geom_point()+
#   geom_text(aes(label=as.character(TRIP)))#outliers have been removed and data appear far more clean
```

Plot data by year/year bin
```{r}
ggplot(hal_datOR) +
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT, col = TYPE), alpha = 0.5)+
  facet_wrap(~yr_bin)

data_byyear <- hal_datOR %>% count(YEAR, TYPE)

ggplot(hal_datOR) +
  geom_bar(aes(yr_bin, stat = "count"))+
  facet_grid(TYPE ~ ., scales = "free")

ggplot(hal_datOR) +
  geom_histogram(aes(FISH_LENGTH, state = "count"), alpha = 0.5) +
  facet_wrap(~YEAR)

```

Looking at the data by gear/NAFO
```{r}
ggplot(hal_datOR) +
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT, col = GEAR), alpha = 0.5)

ggplot(hal_datOR, aes(FISH_LENGTH, fill = GEAR, col = GEAR)) +                       
  geom_histogram(position = "identity", alpha = 0.2, bins = 50) #overall trawl catches smaller fish

ggplot(hal_datOR, aes(FISH_LENGTH, fill = GEAR, col = GEAR)) +                       
  geom_histogram(position = "identity", alpha = 0.2, bins = 50) +
  facet_wrap(~yr_bin, scales = "free") ##trawl consistently caught smaller fish, even when there was significantly more trawling than longlining, but WAY more fish overall caught on longline (when scales = "free" is removed from the facet you see this)
#no real difference in the size of fish caught?
```


Looking for month/seasonal 

```{r}
hal_datOR <- hal_datOR %>%
  mutate(MONTH = substr(BOARD_DATE, 6,7))

#an overall look at how many data we have for each month of the year
ggplot(hal_datOR) +
  geom_histogram(aes(FISH_LENGTH, stat = "count")) +
  facet_wrap(~MONTH)

#creating seasons
hal_datOR <- hal_datOR %>%
    mutate(QUARTER = 
           ifelse(MONTH %in% c("01","02","03"), "1", 
           ifelse(MONTH %in% c("04","05","06"), "2",
           ifelse(MONTH %in% c("07","08","09"), "3", 
           ifelse(MONTH %in% c("10","11","12"), "4", "Error")))))

hal_datOR <- hal_datOR %>%
  mutate(NAFO = replace(NAFO, NAFO %in% c("5Y", "5Z", "4X"), "4X+5"))

#histogram of data by season  
ggplot(hal_datOR, aes(FISH_LENGTH, stat = "count", fill = GEAR, col = GEAR)) +
  geom_histogram(position = "identity", alpha = 0.2) +
  facet_grid(~QUARTER) +
  theme_test()
#histogram of season by NAFO
ggplot(hal_datOR, aes(FISH_LENGTH, stat = "count", fill = GEAR, col = GEAR)) +
  geom_histogram(position = "identity", alpha = 0.2) +
  facet_grid(NAFO~QUARTER) +
  theme_test()
#histogram of season by year bin 

tiff(file="C:/Users/harperd/Documents/Halibut/GitDataInputs/DataInputs/figures/hal_gear_quarter_year.tiff",
     width=10, height=10, units="in", res=500)
ggplot(hal_datOR, aes(FISH_LENGTH, stat = "count", fill = GEAR, col = GEAR)) +
  geom_histogram(position = "identity", alpha = 0.2) +
  facet_grid(yr_bin~QUARTER) +
  theme_test()
dev.off()

```


```{r}
library(lme4)
library(sjp.lmer)
```

```{r}
hal_datOR <- hal_datOR %>%
  mutate(logL = log(FISH_LENGTH), logW = log(FISH_WEIGHT))

#Variable selection: I'm going to say that we could have fish length, quarter, GEAR and NAFO (and maybe even year bin?) as fixed effects; and then we have YEAR as a random effect (when we want to know if something is affecting the response variable and by how much then that would be a fixed effect, if we just expect that something would have an effect on the response variable and we don't care by how much but we want to control by it then that would be a random effect). Basically we need to figure out what we are trying to make predictions about (fixed effects) and what's just "noise" (random effects) that need to be controlled for.
mod3 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + (1|YEAR), hal_datOR)
summary(mod3)
#here we see that YEAR only accounts for 5.65% of the overall variation (divide the variance from YEAR by the overall variance (YEAR+Residual)) so the difference between years explains 5% of the "left over" variance after the variance explained by fixed effects (just fish length here)

#The model above only allows for variation in the intercept, I think we would want to model the variation in the slope as well. So below is a random-slope and random-intercept model...doesn't converge
mod4 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + (1 + (log(FISH_LENGTH))|YEAR), hal_datOR)

summary(mod4)
```

#----MODEL BUILDING (first attempt)----
```{r}
hal_male <- hal_datOR %>%
  filter(SEXCD_ID == "1")
hal_female <- hal_datOR %>%
  filter(SEXCD_ID == "2")
hal_unknowns <- hal_datOR %>%
  filter(SEXCD_ID == "0")
```

Starting with the overall model selection
Here I will start with the most basic model, with a random effect of YEAR (where the intercepts will vary by the random effect for the different levels, but the slope will be fixed 

I chose year as the random effect as I expect to see variation due to it, but want to control for that. I have fish length, quarter, and NAFO as fixed effects since I expect them to have an affect and we want to know how much (make predictions about them)
```{r}
library(lmerTest)
hal_datOR3 <- hal_datOR %>%
  drop_na(NAFO) %>%
  drop_na(SEXCD_ID)

hal_datOR %>% count(FISH_LENGTH)


mod1OA <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + (1|YEAR), hal_datOR3)

#mod1RIRS <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + (1 + log(FISH_LENGTH)|YEAR))  #I think this is how you would write it for random intercept and random slope for the different levels of the random effect?

mod2OA <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + NAFO + SEXCD_ID + (1|YEAR), hal_datOR3)
summary(mod2OA)

mod3OA <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + NAFO + (1|YEAR), hal_datOR3) #results of anova basically say NAFO does nothing?

mod4OA <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + NAFO + (1|YEAR), hal_datOR3)

mod5OA <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + (1 + QUARTER|YEAR), hal_datOR3) #model with random intercepts and slopes, is it right to think that this means that there would be differences in slopes by quarter for the different years?

anova(mod1OA, mod2OA, mod3OA, mod4OA, mod5OA)

cc <- scales::seq_gradient_pal("yellow", "blue", "Lab")(seq(0,1,length.out=52))
ggplot(hal_datOR3, aes(x = FISH_LENGTH, y = FISH_WEIGHT, colour = YEAR)) +
  scale_colour_manual(values = cc) +
      facet_wrap(~QUARTER) +   
      theme_classic() +
      geom_line(data = cbind(hal_datOR3, pred = exp(predict(mod5OA))), aes(y = pred), size = 1) +  # adding predicted line from mixed model 
      theme(legend.position = "none",
            panel.spacing = unit(2, "lines"))
```


#----Updates----

Starting with reducing the number of trip types so that any type with less than 30 observations are lumped into other
```{r}
hal_datOR<- hal_datOR %>%
  drop_na(SEXCD_ID) %>%
  drop_na(NAFO) %>%
  drop_na(FISH_LENGTH) %>%
  drop_na(FISH_WEIGHT)

hal_datORtrip <- hal_datOR %>%
  mutate(TRIPCD_ID = replace(TRIPCD_ID, TRIPCD_ID %in% c("8", "70", "230", "4320", "7054", "7055","7060", "7061"), "7099"))

hal_datOR <- hal_datOR %>%
  mutate(TRIPCD_ID = replace(TRIPCD_ID, TRIPCD_ID %in% c("8", "70", "230", "4320", "7054", "7055","7060", "7061"), "7099"))

hal_datORtrip$TRIPCD_ID <- as.integer(hal_datORtrip$TRIPCD_ID)

hal_datORtrip %>% count(TRIPCD_ID)

#NA here are the RV trips
trips_halcaught2 <- hal_datORtrip %>%
  left_join(ISTRIPTYPECODES, by = "TRIPCD_ID") %>%
  dplyr::select("TRIPCD_ID", "TRIP_TYPE") %>%
  count(TRIPCD_ID, TRIP_TYPE)
```

Reducing NAFO to 3 and 4/5
```{r}
hal_datOR <- hal_datOR %>%
  mutate(NAFO_ZONE = substr(NAFO,1,1)) %>%
  mutate(NAFO_ZONE = replace(NAFO_ZONE, NAFO_ZONE == 4, "4+5"))
```


Checking the predicted values for the different sexes (male = 1, female = 2, unknown = 0)
```{r}
mod_all1 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + SEXCD_ID + NAFO_ZONE + (1|YEAR) + (1|TRIPCD_ID), hal_datOR)

library("ggeffects")
sextest <- ggpredict(mod_all1, terms = c("FISH_LENGTH", "SEXCD_ID"), condition = c(QUARTER = 2, NAFO_ZONE = 3), type = "re") #since QUARTER and NAFO_ZONE are categorical I don't actually need to put these conditions in here because ggpredict() picks a reference level of each categorical predictor anyways

ggplot(sextest, aes(x = x, y = predicted, colour = group)) +
  geom_line() +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), linetype=0, alpha = .15)+
  labs(
    colour = get_legend_title(sextest),
    x = get_x_title(sextest),
    y = get_y_title(sextest),
    title = get_title(sextest)
  )

library("sjPlot")
plot(sextest)
plot_model(mod_all1, type = "pred", terms = c("FISH_LENGTH", "SEXCD_ID"))
```

Checking predicted values for different quarters (Jan-Mar = 1, Apr-Jun = 2, Jul-Sept = 3, Oct-Dec = 4)
```{r}
Qtest <- ggpredict(mod_all1, terms = c("FISH_LENGTH", "QUARTER"), condition = c(NAFO = 3, SEXCD_ID = c(0,1,2)), type = "re")

ggplot(Qtest, aes(x = x, y = predicted, colour = group)) +
  geom_line() +
  labs(
    colour = get_legend_title(Qtest),
    x = get_x_title(Qtest),
    y = get_y_title(Qtest),
    title = get_title(Qtest)
  )

plot(Qtest)
```
Checking predicted values for different NAFO (3 and 4/5)
```{r}
NAFOtest <- ggpredict(mod_all1, terms = c("FISH_LENGTH", "NAFO_ZONE"), condition = c(QUARTER = 2, SEXCD_ID = c(0,1,2)), type = "re")

ggplot(NAFOtest, aes(x = x, y = predicted, colour = group)) +
  geom_line() +
  facet_wrap(~group)+
  labs(
    colour = get_legend_title(NAFOtest),
    x = get_x_title(NAFOtest),
    y = get_y_title(NAFOtest),
    title = get_title(NAFOtest)
  )

plot(NAFOtest)
```

model with unknowns removed! Here with unknowns removed you still see that males and females are basically the same...
```{r}
unrm_haldat <- hal_datOR %>%
  filter(SEXCD_ID != "0")

mod_sex_unrm <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + SEXCD_ID + NAFO_ZONE + (1|YEAR) + (1|TRIPCD_ID), unrm_haldat)

sextest2 <- ggpredict(mod_sex_unrm, terms = c("FISH_LENGTH", "SEXCD_ID"), condition = c(QUARTER = 2, NAFO_ZONE = 3), type = "re") #since QUARTER and NAFO_ZONE are categorical I don't actually need to put these conditions in here because ggpredict() picks a reference level of each categorical predictor anyways

ggplot(sextest2, aes(x = x, y = predicted, colour = group)) +
  geom_line() +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), linetype=0, alpha = .15)+
  labs(
    colour = get_legend_title(sextest2),
    x = get_x_title(sextest2),
    y = get_y_title(sextest2),
    title = get_title(sextest2)
  )


plot(sextest2)

```

model selection

```{r}
#overall (FE: length, sex, quarter, nafo; RE: trip, year)
hal_datORmf <-hal_datOR %>%
  filter(SEXCD_ID %in% c("1", "2"))

m1mf <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + SEXCD_ID + NAFO_ZONE + (1|YEAR) + (1|TRIPCD_ID), hal_datORmf)
#summary(m1mf)
#simple lm of L X W
m2mf <- lm(log(FISH_WEIGHT) ~ log(FISH_LENGTH), hal_datORmf)
#(FE: length; RE: year)
m3mf <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + (1|YEAR), hal_datORmf)
#(FE: length; RE: trip)
m4mf <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + (1|TRIPCD_ID), hal_datORmf)
#(FE:length; RE: trip, year)
m5mf <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + (1|YEAR) + (1|TRIPCD_ID), hal_datORmf)
#(FE: length, sex; RE: trip, year)
m6mf <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + SEXCD_ID + (1|YEAR) + (1|TRIPCD_ID), hal_datORmf)
#(FE: length, quarter; RE: trip, year)
m7mf <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + (1|YEAR) + (1|TRIPCD_ID), hal_datORmf)
#(FE: length, nafo; RE: trip, year)
m8mf <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + NAFO_ZONE + (1|YEAR) + (1|TRIPCD_ID), hal_datORmf)
#(FE: length, sex, quarter; RE: trip, year)
m9mf <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + SEXCD_ID + QUARTER + (1|YEAR) + (1|TRIPCD_ID), hal_datORmf)
#(FE: length, sex, nafo; RE: trip, year)
m10mf <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + SEXCD_ID + NAFO_ZONE + (1|YEAR) + (1|TRIPCD_ID), hal_datORmf)
#(FE: length, quarter, nafo; RE: trip, year)
m11mf <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + NAFO_ZONE + (1|YEAR) + (1|TRIPCD_ID), hal_datORmf)



anova(m1mf, m2mf, m3mf, m4mf, m5mf, m6mf, m7mf, m8mf, m9mf, m10mf, m11mf)
#AIC smaller  = better...in the case where it's negative, would most negative be better? (if so: m9 and m1 are very close...only difference is NAFO_ZONE is not in m9, so that would make is a slightly better model as NAFO_ZONE as a parameter does basically nothing?)
#m5 and m8 are basically the same (according to the anova) which makes sense since NAFO seems to have basically no effect (not significant and visualizations show total overlap)

plot_model(m1mf, type = "pred", terms = c("FISH_LENGTH", "QUARTER", "SEXCD_ID", "NAFO_ZONE"))
```

Looking at month (to see whether season trend still there or is quarter is just noise)
```{r}
library(ggeffects)
modmonth <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + SEXCD_ID + MONTH + NAFO_ZONE + (1|YEAR) + (1|TRIPCD_ID), hal_datORmf)

monthtest <- ggpredict(modmonth, terms = c("FISH_LENGTH", "MONTH"), condition = c(SEXCD_ID = c(1,2), NAFO_ZONE = 3), type = "re")

cc <- scales::seq_gradient_pal("pink", "blue", "Lab")(seq(0,1,length.out=12))
ggplot(monthtest, aes(x = x, y = predicted, colour = group)) +
  scale_colour_manual(values=cc)+
  geom_line(size = 1) +
  geom_text(data = monthtest %>% filter(x == last(x)), aes(label = group, 
                                                           x = x, 
                                                           y = predicted, 
                                                           color = group), nudge_x = 10, ) + 
  labs(
    colour = get_legend_title(monthtest),
    x = get_x_title(monthtest),
    y = get_y_title(monthtest),
    title = get_title(monthtest)
  ) 

#xlim(200,300) + ylim(200000, 250000)

#shows that for a given length fish are lightest in january, getting heavier through the year until late summer when weight decreases a bit until december and then stark drop back down to lowest in january

ggplot(hal_datORmf, aes(FISH_LENGTH, stat = "count", fill = SEXCD_ID, col = SEXCD_ID)) +
  geom_histogram(position = "identity", alpha = 0.2) +
  facet_grid(~MONTH) +
  theme_test()

#shows very little data in quarter 4 (oct, nov, dec)
```
Looking at the year: look at decadal trend
```{r}
hal_datOR <- hal_datOR %>%
  mutate(yr_bin10 = 
           ifelse(YEAR %in% c(1970, 1971, 1972, 1973, 1974, 1975, 1976, 1977, 1978, 1979, 1980), "1970-1980", 
           ifelse(YEAR %in% c(1981, 1982, 1983, 1984, 1985, 1986, 1987, 1988, 1989, 1990), "1981-1990", 
           ifelse(YEAR %in% c(1991, 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999, 2000), "1991-2000",
           ifelse(YEAR %in% c(2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010), "2001-2010",
           ifelse(YEAR %in% c(2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020), "2011-2020", 
           ifelse(YEAR %in% c(2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 2019, 2020), "2011-2020", "Error")))))))

moddecade <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + SEXCD_ID + NAFO_ZONE + yr_bin10 + (1|TRIPCD_ID), hal_datOR)

dectest <- ggpredict(moddecade, terms = c("FISH_LENGTH", "yr_bin10"), condition = c(SEXCD_ID = c(1,2), NAFO_ZONE = 3), type = "re")

cc <- scales::seq_gradient_pal("pink", "blue", "Lab")(seq(0,1,length.out=6))
ggplot(dectest, aes(x = x, y = predicted, colour = group)) +
  scale_colour_manual(values=cc)+
  geom_line(size = 1) +
  geom_text(data = dectest %>% filter(x == last(x)), aes(label = group, 
                                                           x = x, 
                                                           y = predicted, 
                                                           color = group), nudge_x = 10, ) + 
  labs(
    colour = get_legend_title(dectest),
    x = get_x_title(dectest),
    y = get_y_title(dectest),
    title = get_title(dectest)
  )

summary(moddecade)

hal_datORRV <- hal_datOR %>%
  filter(TYPE == "RV")

moddecadeRV <- lm(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + yr_bin10, hal_datORRV)

dectestRV <- ggpredict(moddecadeRV, terms = c("FISH_LENGTH", "yr_bin10"), condition = c(SEXCD_ID = c(1,2), NAFO_ZONE = 3), type = "re")

cc <- scales::seq_gradient_pal("pink", "blue", "Lab")(seq(0,1,length.out=6))
ggplot(dectestRV, aes(x = x, y = predicted, colour = group)) +
  scale_colour_manual(values=cc)+
  geom_line(size = 1) +
  geom_text(data = dectestRV %>% filter(x == last(x)), aes(label = group, 
                                                           x = x, 
                                                           y = predicted, 
                                                           color = group), nudge_x = 10, ) + 
  labs(
    colour = get_legend_title(dectestRV),
    x = get_x_title(dectestRV),
    y = get_y_title(dectestRV),
    title = get_title(dectestRV)
  )

#looking at just the last two decades
hal_last2dec <- hal_datOR %>%
  filter(yr_bin10 %in% c("2001-2010", "2011-2020"))

moddecade2 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + SEXCD_ID + NAFO_ZONE + yr_bin10 + (1|TRIPCD_ID), hal_last2dec)

dectest2 <- ggpredict(moddecade2, terms = c("FISH_LENGTH", "yr_bin10"), condition = c(SEXCD_ID = c(1,2), NAFO_ZONE = 3), type = "re")

ggplot(dectest2, aes(x = x, y = predicted, colour = group)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), linetype=0, alpha = .15)+
  geom_text(data = dectest2 %>% filter(x == last(x)), aes(label = group, 
                                                           x = x, 
                                                           y = predicted, 
                                                           color = group), nudge_x = 10, ) + 
  labs(
    colour = get_legend_title(dectest2),
    x = get_x_title(dectest2),
    y = get_y_title(dectest2),
    title = get_title(dectest2)
  )

summary(moddecade2)
```


look at the distribution of jan/dec samples
```{r}
ggplot(hal_datORmf, aes(FISH_LENGTH, stat = "count", fill = SEXCD_ID, col = SEXCD_ID)) +
  geom_histogram(position = "identity", alpha = 0.2) +
  facet_grid(NAFO~MONTH) +
  theme_test()

```

Try to look at prediction for a legal size fish (90cm) for time period
```{r}
modyear <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + SEXCD_ID + NAFO_ZONE + YEAR + (1|TRIPCD_ID), hal_datOR)

yeartest <- ggpredict(modyear, terms = c("FISH_LENGTH", "YEAR"), condition = c(SEXCD_ID = c(1,2), NAFO_ZONE = 3), type = "re")

sizeselect <- yeartest %>% filter(x == "80")
ggplot(sizeselect, aes(group, predicted)) + geom_line()
library(ggeffects)
ggplot(sizeselect, aes(group, predicted, group = 1)) +
  geom_line(aes(group, predicted, group = key))+
    labs(
    colour = get_legend_title(sizeselect),
    x = "YEAR",
    y = "FISH_WEIGHT",
    title = "Predicted Values for Fish at Length 80cm Over Time"
  ) +
  theme_test()

##same thing but just RV data
modyearRV <- lm(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + YEAR, hal_datORRV)

yeartestRV <- ggpredict(modyearRV, terms = c("FISH_LENGTH", "YEAR"), condition = c(SEXCD_ID = c(1,2), NAFO_ZONE = 3), type = "re")

sizeselectRV <- yeartestRV %>% filter(x == "80")

ggplot(sizeselectRV, aes(x = group, y = predicted)) +
  geom_point() +
    labs(
    colour = get_legend_title(sizeselectRV),
    x = "YEAR",
    y = "FISH_WEIGHT",
    title = "Predicted Values for Fish at Length 80cm Over Time from RV Data"
  ) +
  theme_test()


```

Final Model: using all data (female, male, and unknown) 
```{r}
library(sjPlot)

#With QUARTER...not the one Brad wants for assessment model
final_mod <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + (1|YEAR) + (1|TRIPCD_ID), hal_datOR)
summary(final_mod)
coef(summary(final_mod))
fixef(final_mod)

df2 <- data.frame(YEAR=row.names(coef(final_mod)[[1]]), coef(final_mod)[[1]])

##overall (without QUARTER)
final_modOA <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + (1|YEAR) + (1|TRIPCD_ID), hal_datOR)
summary(final_modOA)
coef(summary(final_modOA))
fixef(final_modOA)
coef(final_mod)

final_pred <- ggpredict(final_modOA, terms = c("FISH_LENGTH"), type = "re")
final_<-predict(final_modOA, list(FISH_LENGTH = hal_datOR$FISH_LENGTH))
final_pred2 <- as.data.frame(exp(predict(final_modOA, newdata = data.frame(FISH_LENGTH = 1:200), type = "response", re.form = NA)), options(scipen=999))

tab_model(final_mod, final_modOA,  file="tab_model.html")
tab_model(final_mod, final_modOA)
plot_model(final_mod, type = "pred", terms = c("FISH_LENGTH", "QUARTER"), colors = "bw") + theme_classic()



exp(predict(final_mod, newdata = data.frame(FISH_LENGTH = 80, QUARTER = as.factor(1:4)), type = "response", re.form = NA))

exp(fixef(final_mod)[1])/exp((fixef(final_mod)[1])+(fixef(final_mod)[3]))

#5558.274/5753.527

library("webshot")
webshot("tab_model.html", "C:/Users/harperd/Documents/Halibut/GitDataInputs/DataInputs/tab_modeloutput.png")
```

Some final figures potentially (should the unknowns be removed?? I can't remember what we decided?)
```{r}
m1everything <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + SEXCD_ID + NAFO_ZONE + (1|YEAR) + (1|TRIPCD_ID), hal_datOR)
library("see")
plot_model(m1everything, type = "pred", terms = c("FISH_LENGTH", "QUARTER", "NAFO_ZONE", "SEXCD_ID"))

#OR
pQ <- plot_model(m1everything, type = "pred", terms = c("FISH_LENGTH", "QUARTER")) + theme_classic() + xlab("") + ylab("") + ggtitle("")
pS <- plot_model(m1everything, type = "pred", terms = c("FISH_LENGTH", "SEXCD_ID")) + theme_classic() + xlab("") + ylab("") + ggtitle("")
pN <- plot_model(m1everything, type = "pred", terms = c("FISH_LENGTH", "NAFO_ZONE")) + theme_classic() + xlab("") + ylab("") + ggtitle("")

library("ggpubr")
var_plot <- ggarrange(pQ, pS, pN, ncol = 1, nrow = 3)
var_plot
var_plot <- annotate_figure(var_plot, left = "Predicted Fish Weight (g)", bottom = "Fish Length (cm)")
var_plot
```

Creating dataframe for proportion at age for length data (divided by NAFO (3NOPs, 4VWX), year, sex (and combined))

THIS CODE DOESN'T WORK!
```{r}
#making NAFO categories
figdat <- ISDB_halall %>%
  mutate(NAFO = substr(NAFO,1,1)) %>%
  mutate(NAFO = replace(NAFO, NAFO == 5, "4")) %>%
  mutate(NAFO = replace(NAFO, NAFO == 4, "4VWX+5"), NAFO = replace(NAFO, NAFO == 3, "3NPOs"))

#adding a summary column that's the sum of all observations by NAFO, Year, and Sex
figdat2 <- figdat %>%
  select(YEAR, NAFO, SEXCD_ID, GEAR) %>%
  group_by(YEAR, NAFO, SEXCD_ID, GEAR) %>%
  summarize(total = n())

figdat3 <- figdat2 %>%
  left_join(figdat, by = c("YEAR", "NAFO", "SEXCD_ID", "GEAR")) %>%
  select("YEAR", "NAFO", "SEXCD_ID", "FISH_LENGTH", "total", "GEAR")

figdat3 <- figdat3 %>% mutate(uid = row_number())

figdat4 <- figdat3 %>%
  spread(FISH_LENGTH, uid) %>%
  select("YEAR", "NAFO", "SEXCD_ID", "GEAR", "total", 7:207)

figdat4 <- figdat4 %>%
  group_by(YEAR, NAFO, SEXCD_ID, GEAR) %>%
  summarize(across(2:202, sum))

figdat5 <- figdat4 %>%
  gather(key="length", value="count", 6:206) 
  


figdat3 %>%
  filter(YEAR %in% c(2008, 2009, 2010, 2011), NAFO == "3NPOs", GEAR == "longline") %>%
  ggplot(aes(x = FISH_LENGTH)) +
  facet_grid(YEAR~SEXCD_ID) +
  geom_histogram(aes(y = stat(count / sum(count))), binwidth = 3) +
  xlim(0, 262) + ylim(0, 0.02)+
  theme_test()
```

Data for table updates
```{r}
#Table 2
tables <- hal_datOR %>%
  select("YEAR", "NAFAREA_ID", "TYPE", "FISH_LENGTH") %>%
    mutate(NAFO = substr(NAFAREA_ID,1,1)) %>%
  select(-"NAFAREA_ID") %>%
  group_by(YEAR, TYPE, NAFO) %>%
  summarize(n=n())

tables2 <- spread(tables, NAFO, n)

tablesISDB <- tables2 %>% filter(TYPE == "ISDB")
tablesRV <- tables2 %>% filter(TYPE== "RV")

#Table 3
tab_month <- hal_datOR %>%
  select("SEXCD_ID", "FISH_LENGTH", "MONTH")%>%
  group_by(SEXCD_ID, MONTH) %>%
  summarize(n=n())
tab_month <- spread(tab_month, MONTH, n)

```

Figure for document of raw data
```{r}
ggplot(hal_datOR, aes(FISH_LENGTH, stat = "count", fill = TYPE, col = TYPE)) +
  geom_histogram(position = "identity", alpha = 0.2) +
  facet_grid(NAFO~QUARTER) +
  theme_test() +
  xlab("Fish Length (cm)") + ylab("Number of Halibut") +
  labs(fill="Data Source", color="Data Source") +
  scale_fill_discrete(labels = c("Observer", "RV Survey"))+
  scale_color_discrete(labels = c("Observer", "RV Survey")) +
  scale_color_manual(values=c("skyblue4", "firebrick"))+
  scale_fill_manual(values=c("skyblue4", "firebrick"))



ggplot(hal_datOR, aes(FISH_LENGTH, stat = "count", fill = TYPE, col = TYPE)) +
  geom_histogram(position = "identity", alpha = 0.2) +
  facet_grid(yr_bin~.) +
  theme_test() +
  xlab("Fish Length (cm)") + ylab("Number of Halibut") +
  labs(fill="Data Source", color="Data Source") +
  scale_fill_discrete(labels = c("ISDB", "RV"))+
  scale_color_discrete(labels = c("ISDB", "RV"))+
    scale_color_manual(values=c("skyblue4", "firebrick"))+
  scale_fill_manual(values=c("skyblue4", "firebrick"))

#theme(legend.position="top")
```

Model selection where final model has unsexed data
```{r}
m1mf <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + SEXCD_ID + NAFO_ZONE + (1|YEAR) + (1|TRIPCD_ID), hal_datORmf)
#summary(m1mf)
#simple lm of L X W
m2mf <- lm(log(FISH_WEIGHT) ~ log(FISH_LENGTH), hal_datORmf)
#(FE: length; RE: year)
m3mf <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + (1|YEAR), hal_datORmf)
#(FE: length; RE: trip)
m4mf <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + (1|TRIPCD_ID), hal_datORmf)
#(FE:length; RE: trip, year)
m5mf <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + (1|YEAR) + (1|TRIPCD_ID), hal_datORmf)
#(FE: length, sex; RE: trip, year)
m6mf <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + SEXCD_ID + (1|YEAR) + (1|TRIPCD_ID), hal_datORmf)
#(FE: length, quarter; RE: trip, year)
m7mf <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + (1|YEAR) + (1|TRIPCD_ID), hal_datORmf)
#(FE: length, nafo; RE: trip, year)
m8mf <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + NAFO_ZONE + (1|YEAR) + (1|TRIPCD_ID), hal_datORmf)
#(FE: length, sex, quarter; RE: trip, year)
m9mf <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + SEXCD_ID + QUARTER + (1|YEAR) + (1|TRIPCD_ID), hal_datORmf)
#(FE: length, sex, nafo; RE: trip, year)
m10mf <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + SEXCD_ID + NAFO_ZONE + (1|YEAR) + (1|TRIPCD_ID), hal_datORmf)
#(FE: length, quarter, nafo; RE: trip, year)
m11mf <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + NAFO_ZONE + (1|YEAR) + (1|TRIPCD_ID), hal_datORmf)


anova(m1mf, m2mf, m3mf, m4mf, m5mf, m6mf, m7mf, m8mf, m9mf, m10mf, m11mf)
#AIC smaller  = better...in the case where it's negative, would most negative be better? (if so: m9 and m1 are very close...only difference is NAFO_ZONE is not in m9, so that would make is a slightly better model as NAFO_ZONE as a parameter does basically nothing?)
#m5 and m8 are basically the same (according to the anova) which makes sense since NAFO seems to have basically no effect (not significant and visualizations show total overlap)

plot_model(m1mf, type = "pred", terms = c("FISH_LENGTH", "QUARTER", "SEXCD_ID", "NAFO_ZONE"))
```



Checking outliers using same method as previous assessment but with a and b from this model...the same number of outliers are removed
```{r}
test2_halAll <- hal_datAll %>%
  dplyr::select(id, FISH_LENGTH, FISH_WEIGHT, TRIP, TRIPCD_ID)

test2_halAll$out<-0
test2_halAll<-test_halAll[!is.na(test2_halAll$FISH_LENGTH),]
test2_halAll<-test_halAll[!is.na(test2_halAll$FISH_WEIGHT),]

#identify outliers (using a and b from THIS assessment log(a) = -4.996801, b =3.119528, so a = 0.006759536)
mod_outliers2<-nls(FISH_WEIGHT~a*FISH_LENGTH^b,data=test_halAll,start=c(a=0.006759536,b=3.119528),na.action=na.omit) 

#these results are the same with a=0.001 and b=3 as was used by nell in her getLW function from the previous assessment
test2_halAll$upper<-predict(mod_outliers2, list(FISH_LENGTH = test2_halAll$FISH_LENGTH))*1.75
test2_halAll$lower<-predict(mod_outliers2, list(FISH_LENGTH = test2_halAll$FISH_LENGTH))*0.25
test2_halAll$out[test2_halAll$FISH_WEIGHT<test2_halAll$upper&test2_halAll$FISH_WEIGHT>test2_halAll$lower]<-1
test2_lenwt.dat.all<-test_halAll[,c(1:8)]

all_outliers2 <- test2_lenwt.dat.all %>% filter(out == "0") #here we lose 326 fish as outliers (the overall dataset, it's 0.56%) 
test2_full <- test2_lenwt.dat.all %>% filter(out == "1") 

#bring test_full back together with the other df
test2_full <- test2_full %>%
  dplyr::select("id") %>%
  left_join(hal_datAll, by = "id")

test2_full %>%
  filter(FISH_WEIGHT < 250) %>%
  ggplot(aes(FISH_LENGTH, FISH_WEIGHT))+
  geom_point()
#the problem seen above where issues arose due to kg vs. g units is not seen here, these data seem cleaned

ggplot(test2_full, aes(FISH_LENGTH, FISH_WEIGHT))+
  geom_point()

hal_datOR_new <- test2_full

# test_full %>% filter(between(FISH_LENGTH, 175, 200), between(FISH_WEIGHT, 20000, 21000)) %>%
# ggplot(aes(FISH_LENGTH, FISH_WEIGHT, label=TRIP))+
#   geom_point()+
#   geom_text(aes(label=as.character(TRIP)))#outliers have been removed and data appear far more clean
```

Checking outliers using the boxplot method...bocplot method uses interquartile range and removes anything outside the 25th and 75th percentile (+/- 1.5*IQR)...using the predicted data here instead you get the same 326 outliers using the box plot method as using the interquartile range Nell used...because they are basically doing the same thing...very different than using the boxplot on the raw data...not sure how else to do this?
```{r}
hal_datAll2 <- hal_datAll

hal_datAll2 <- hal_datAll

hal_datAll2 <- hal_datAll2 %>%
  mutate(log_a = log(FISH_LENGTH), log_b = log(FISH_WEIGHT))

hal_datAll2test <- hal_datAll2 %>%
  dplyr::select(id, FISH_LENGTH, FISH_WEIGHT, TRIP, TRIPCD_ID)


hal_datAll2test$out<-0
hal_datAll2test<-hal_datAll2test[!is.na(hal_datAll2test$FISH_LENGTH),]
hal_datAll2test<-hal_datAll2test[!is.na(hal_datAll2test$FISH_WEIGHT),]

#identify outliers (using a and b from THIS assessment log(a) = -4.996801, b =3.119528, so a = 0.006759536)
mod_outliers2<-nls(FISH_WEIGHT~a*FISH_LENGTH^b,data=test_halAll,start=c(a=0.001,b=3),na.action=na.omit) 

#these results are the same with a=0.001 and b=3 as was used by nell in her getLW function from the previous assessment
hal_datAll2test$upper<-predict(mod_outliers2, list(FISH_LENGTH = hal_datAll2test$FISH_LENGTH))*1.75
hal_datAll2test$lower<-predict(mod_outliers2, list(FISH_LENGTH = hal_datAll2test$FISH_LENGTH))*0.25
hal_datAll2test$out[hal_datAll2test$FISH_WEIGHT<hal_datAll2test$upper&hal_datAll2test$FISH_WEIGHT>hal_datAll2test$lower]<-1

hal_datAll2test<-hal_datAll2test[,c(1:8)]

all_outliers3 <- hal_datAll2test %>% filter(out == "0") #here we lose 326 fish as outliers (the overall dataset, it's 0.56%) 
hal_datAll2test <- hal_datAll2test %>% filter(out == "1") 

hal_datAll2 <- hal_datAll2test %>%
  dplyr::select("id") %>%
  left_join(hal_datAll2, by %in% C())

###WRONG!!
# base boxplot and outliers
boxplot(hal_datAll2test$FISH_WEIGHT ~ hal_datAll2test$FISH_LENGTH)
boxplot(hal_datAll2test$FISH_WEIGHT ~ hal_datAll2test$FISH_LENGTH)$out
subset(hal_datAll2test, hal_datAll2test$FISH_WEIGHT %in% boxplot(hal_datAll2test$FISH_WEIGHT ~ hal_datAll2test$FISH_LENGTH)$out)

# columns for visualization
hal_datAll2test$OUTLIER <- ifelse(hal_datAll2test$FISH_WEIGHT %in% boxplot(hal_datAll2test$FISH_WEIGHT ~ hal_datAll2test$FISH_LENGTH, plot = F)$out, hal_datAll2test$FISH_WEIGHT, NA)
hal_datAll2test$INLIER <- ifelse(is.na(hal_datAll2test$OUTLIER), hal_datAll2test$FISH_WEIGHT, NA)

hal_datAll2test_out <- hal_datAll2test %>% drop_na(OUTLIER)
hal_datAll2test <- hal_datAll2test %>% drop_na(INLIER)
```

Looking at that data (removing outliers from all data means dropping 13,305 observations; further removing all unknown for sex drops 19,353 observations)
```{r}
hal_datAll2 <- hal_datAll2 %>%
  mutate(MONTH = substr(BOARD_DATE, 6,7))

hal_datAll2 <- hal_datAll2 %>%
    mutate(QUARTER = 
           ifelse(MONTH %in% c("01","02","03"), "1", 
           ifelse(MONTH %in% c("04","05","06"), "2",
           ifelse(MONTH %in% c("07","08","09"), "3", 
           ifelse(MONTH %in% c("10","11","12"), "4", "Error")))))

hal_datAll2 <- hal_datAll2 %>%
  mutate(NAFO = replace(NAFO, NAFO %in% c("5Y", "5Z", "4X"), "4X+5"))

hal_datAll2 <- hal_datAll2 %>%
  mutate(NAFO_ZONE = substr(NAFO,1,1)) %>%
  mutate(NAFO_ZONE = replace(NAFO_ZONE, NAFO_ZONE == 4, "4+5"))

hal_datAll2mf <- hal_datAll2 %>% filter(SEXCD_ID %in% c(1, 2))


m1mf2 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + SEXCD_ID + NAFO_ZONE + (1|YEAR) + (1|TRIPCD_ID), hal_datAll2mf)
summary(m1mf2)
#simple lm of L X W
m2mf2 <- lm(log(FISH_WEIGHT) ~ log(FISH_LENGTH), hal_datAll2mf)
#(FE: length; RE: year)
m3mf2 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + (1|YEAR), hal_datAll2mf)
#(FE: length; RE: trip)
m4mf2 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + (1|TRIPCD_ID), hal_datAll2mf)
#(FE:length; RE: trip, year)
m5mf2 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + (1|YEAR) + (1|TRIPCD_ID), hal_datAll2mf)
#(FE: length, sex; RE: trip, year)
m6mf2 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + SEXCD_ID + (1|YEAR) + (1|TRIPCD_ID), hal_datAll2mf)
#(FE: length, quarter; RE: trip, year)
m7mf2 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + (1|YEAR) + (1|TRIPCD_ID), hal_datAll2mf)
#(FE: length, nafo; RE: trip, year)
m8mf2 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + NAFO_ZONE + (1|YEAR) + (1|TRIPCD_ID), hal_datAll2mf)
#(FE: length, sex, quarter; RE: trip, year)
m9mf2 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + SEXCD_ID + QUARTER + (1|YEAR) + (1|TRIPCD_ID), hal_datAll2mf)
#(FE: length, sex, nafo; RE: trip, year)
m10mf2 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + SEXCD_ID + NAFO_ZONE + (1|YEAR) + (1|TRIPCD_ID), hal_datAll2mf)
#(FE: length, quarter, nafo; RE: trip, year)
m11mf2 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + NAFO_ZONE + (1|YEAR) + (1|TRIPCD_ID), hal_datAll2mf)


anova(m1mf2, m2mf2, m3mf2, m4mf2, m5mf2, m6mf2, m7mf2, m8mf2, m9mf2, m10mf2, m11mf2)


mod_finalOA2 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + (1|YEAR) + (1|TRIPCD_ID), hal_datAll2)
summary(mod_finalOA2)
coef(summary(mod_finalOA2))
fixef(mod_finalOA2)
coef(mod_finalOA2)

tab_model(final_mod, final_modOA,  file="tab_model.html")
tab_model(final_modOA)
plot_model(final_mod, type = "pred", terms = c("FISH_LENGTH", "QUARTER"), colors = "bw") + theme_classic()
  
mod_finalQ2 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + (1|YEAR) + (1|TRIPCD_ID), hal_datAll2)
summary(mod_finalQ2)
coef(summary(mod_finalQ2))
fixef(mod_finalQ2)
 

##plotting quarter for interest
Qtest2 <- ggpredict(m1mf2, terms = c("FISH_LENGTH", "QUARTER"), condition = c(NAFO = 3, SEXCD_ID = c(0,1,2)), type = "re")

ggplot(Qtest, aes(x = x, y = predicted, colour = group)) +
  geom_line() +
  labs(
    colour = get_legend_title(Qtest),
    x = get_x_title(Qtest),
    y = get_y_title(Qtest),
    title = get_title(Qtest)
  )

plot(Qtest)
```

Getting the gear into the trip type table
```{r}
hal_datORtrip <- hal_datOR %>%
  mutate(TRIPCD_ID = replace(TRIPCD_ID, TRIPCD_ID %in% c("8", "70", "230", "4320", "7054", "7055","7060", "7061"), "7099"))

hal_datORtrip$TRIPCD_ID <- as.integer(hal_datORtrip$TRIPCD_ID)

hal_datORtrip %>% count(TRIPCD_ID)

#NA here are the RV trips
trips_halcaught2 <- hal_datORtrip %>%
  left_join(ISTRIPTYPECODES, by = "TRIPCD_ID") %>%
  dplyr::select("TRIPCD_ID", "TRIP_TYPE") %>%
  count(TRIPCD_ID, TRIP_TYPE)

hal_tripsgears <- hal_datORtrip %>%
  left_join(ISTRIPTYPECODES, by = "TRIPCD_ID") %>%
  dplyr::select("TRIPCD_ID", "TRIP_TYPE", "GEAR") %>%
  count(TRIPCD_ID, TRIP_TYPE, GEAR)
hal_tripsgears <- hal_tripsgears %>%
  mutate(TRIP_TYPE = replace_na(TRIP_TYPE,"RV"))
```
