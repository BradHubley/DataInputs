---
title: "Length Weight Relationship"
author: "Danni"
date: "February 16, 2021"
output: html_document
--- 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
 library(Mar.datawrangling)
 library(tidyverse)
 library(lubridate)
 library(stringr)

datadir="C:/Users/harperd/Documents/Halibut/RDataVault"
wd="C:/Users/harperd/Documents/Halibut/GitDataInputs/DataInputs/"
source(file.path(wd, ".passwords"))
```

Extract MAR RV survey data using RORACLE
```{r}
#get_data("rv", data.dir = "C:/Users/harperd/Documents/Halibut/RDataVault/", usepkg = "roracle",fn.oracle.username = "hubleyb", fn.oracle.password = "R4#vmxtas", fn.oracle.dsn = "PTRAN", force.extract = T)
```

Extract MAR RV survey data from existing dump
```{r}
get_data("rv", data.dir = datadir)
```

Pull halibut morphology data from the MAR RV survey since beginning of survey data set (1970?)
```{r}
hal <- GSDET %>%
  filter(SPEC == "30")
```

Scatter plot of Length and Weight of halibut from RV survey
```{r}
ggplot(hal, aes(FLEN, FWT)) +
  geom_point()
```
There are 1188 fish that have no weights associated with the lengths in the MAR RV survey data

Combining the hal data with the set info to determine strata
```{r}
setdata_halRV <- merge(hal, GSINF, by.x = c("MISSION","SETNO"), 
                       by.y = c("MISSION","SETNO"), all.x = TRUE, all.y = FALSE) %>% 
  select("MISSION", "SETNO", "SPEC", "FSHNO", "FLEN", "FSEX", "FMAT", "FWT", "AGMAT", "AGE", "CLEN", "REMARKS.x", "SIZE_CLASS", "SDATE", "STRAT", "SLAT", "SLONG", "ELAT", "ELONG", "ETIME", "REMARKS.y", "START_DEPTH", "END_DEPTH", "SURFACE_TEMPERATURE", "BOTTOM_TEMPERATURE", "BOTTOM_SALINITY", "STATION")
```

Joining the Stratum table to attach associated NAFO info
```{r}
setdata_halRV <- setdata_halRV %>%
  left_join(GSSTRATUM, by = "STRAT") %>%
  select(-"DMIN", -"DMAX", -"AREA", -"DEPTH")
```

Create year column and column of 5yr bins starting in 1970
```{r}
setdata_halRV <- setdata_halRV %>%
  mutate(YEAR = substr(SDATE, 1,4))

setdata_halRV <- setdata_halRV %>%
  mutate(yr_bin = 
           ifelse(YEAR %in% c(1970, 1971, 1972, 1973, 1974, 1975), "1970-1975", 
           ifelse(YEAR %in% c(1976, 1977, 1978, 1979, 1980), "1976-1980",
           ifelse(YEAR %in% c(1981, 1982, 1983, 1984, 1985), "1981-1985", 
           ifelse(YEAR %in% c(1986, 1987, 1988, 1989, 1990), "1986-1990",
           ifelse(YEAR %in% c(1991, 1992, 1993, 1994, 1995), "1991-1995",
           ifelse(YEAR %in% c(1996, 1997, 1998, 1999, 2000), "1996-2000",
           ifelse(YEAR %in% c(2001, 2002, 2003, 2004, 2005), "2001-2005",
           ifelse(YEAR %in% c(2006, 2007, 2008, 2009, 2010), "2006-2010",
           ifelse(YEAR %in% c(2011, 2012, 2013, 2014, 2015), "2011-2015",
           ifelse(YEAR %in% c(2016, 2017, 2018, 2019, 2020), "2016-2020", "Error")))))))))))

```


See NAFO zones represented in the hal data from the Mar RV survey data
```{r}
unique(setdata_halRV$NAME)
```
There are 10 fish where there is no corresponding NAFO (can likely just look it up using the coordinates?)

Reducing the fine scale of NAFO regions to the larger zones (e.g. 4Vs to 4V...) in new column NAFO
```{r}
setdata_halRV <- setdata_halRV %>%
  mutate(NAFO = substr(NAME, 1, 2))
```

Graphing the length by weight by larger NAFO zone
```{r}
ggplot(setdata_halRV, aes(FLEN, FWT)) +
  geom_point()+
  facet_wrap(~NAFO)
```
Graphing the length by weight for NAFO and year
```{r}
ggplot(setdata_halRV, aes(FLEN, FWT)) +
  geom_point()+
  facet_grid(YEAR~NAFO)
```

Graphing the length by weight for NAFO and 5yr bins (when colouring the points by sex we lose even more data (from 1188 to 1204 fish not included in the figure below...))
```{r}
ggplot(setdata_halRV, aes(FLEN, FWT, color = as.factor(FSEX))) +
  geom_point()+
  scale_color_manual(name = "FSEX",
                     values = c("0" = "black",
                                  "1" = "blue",
                                  "2" = "deeppink",
                                "NA" = "black"),
  labels = c("0", "male", "female", "NA"))+
  facet_grid(yr_bin~NAFO, scales = "free")
```
Checking how many fish sampled by year and NAFO
```{r}
NAFO_4_5 <- setdata_halRV %>%
  mutate(NAFO = substr(NAFO,1,1))


num_fish_sampled <- data.frame(table(NAFO_4_5$YEAR, NAFO_4_5$NAFO))

#this counts how many fish are in "numb_fish_sampled"
sum(num_fish_sampled$Freq)
```
There are 10 fewer fish in num_fish_sampled than in setdata_RVhal because 10 fish in the original data don't have an associated NAFO zone

Many of these don't match up for NAFO and year...(how is the data so different?)


####NEXT SECTION FOR ISDB DATA ####

Extract ISDB data using RORACLE
```{r}
#get_data("isdb", data.dir = "C:/Users/harperd/Documents/Halibut/RDataVault/", usepkg = "roracle",fn.oracle.username = "hubleyb", fn.oracle.password = "R4#vmxtas", fn.oracle.dsn = "PTRAN", force.extract = T)
```

Pull ISDB data from where it is stored locally (previously pulled from database using oracle)
```{r}
get_data("isdb", data.dir = datadir)
```

Pulling the halibut trips from the trips table (30 = halibut, 7057 = halibut longline survey, 7058 = halibut port sampling)
```{r}
hal_trips <- ISTRIPS %>%
  filter(TRIPCD_ID %in% c("30", "7057"))
```

Pulling all the sets that belong to the halibut trips identified above
```{r}
hal_fishsets <- hal_trips %>%
  left_join(ISFISHSETS, by = "TRIP_ID") %>%
  drop_na(FISHSET_ID) #need to drop NAs as there are 281 catches with NA for fish set in ISCATCHED that are being matched in the next join
```

Pulling out all the catches from the identified sets above
```{r}
hal_catches <- hal_fishsets %>%
  left_join(ISCATCHES, by = "FISHSET_ID")
```
**Weird that for species sought there are other species (30, 12, 15, 7099, 31, 23, 11, 10, 211, 201, 16, NA) even though the trip is identified as trip code 30...should I be isolating for only halibut sought trips???


Pulling out all fish caught in the catches from the halibut trips, and then filtering for just the halibut caught
```{r}
hal_fish <- hal_catches %>%
  left_join(ISFISH, by = "CATCH_ID") %>%
  filter(SPECCD_ID == "30")
```

First exploratory plot: plotting all length against width (some will not be plotted and provides idea of how many individuals are missing a length or weight measurement)
```{r}
ggplot(hal_fish, aes(FISH_LENGTH, FISH_WEIGHT)) +
  geom_point()
```
From looking at the data in hal_fish and the graph there are A LOT of issues: lots of missing lengths and weights, and weights that don't make sense (what's the units for the weights?)
```{r}
hal_fish %>% 
  count(FISH_LENGTH) # 10,949 rows without fish length (of these, 2 have weights and the rest are missing both)

hal_rmNAwt <- hal_fish %>%
  drop_na(FISH_WEIGHT)#from 180,684 observations in hal_fish to 40,256 observations where weight is available
```

Trimming down the dataframe to useful columns
```{r}
hal_fishTrim <- hal_rmNAwt %>%
  select("TRIP_ID", "TRIP", "TRIPCD_ID", "VESS_ID", "LICENSE_NO", "BOARD_DATE", "LANDING_DATE", "FISHSET_ID", "SET_NO", "SETCD_ID", "SPECSCD_ID.x", "NAFAREA_ID", "CATCH_ID", "SPECCD_ID", "FISH_ID", "FISH_NO", "SEXCD_ID", "FISH_LENGTH", "FISH_WEIGHT", "MATCD_ID", "COMMENTS")
```

Create year column and column of 5yr bins starting in 1970
```{r}
hal_fishTrim <- hal_fishTrim %>%
  mutate(YEAR = substr(BOARD_DATE, 1,4)) #all rows have a board date, but some don't have a land date

hal_fishTrim <- hal_fishTrim %>%
  mutate(yr_bin = 
           ifelse(YEAR %in% c(1970, 1971, 1972, 1973, 1974, 1975), "1970-1975", 
           ifelse(YEAR %in% c(1976, 1977, 1978, 1979, 1980), "1976-1980",
           ifelse(YEAR %in% c(1981, 1982, 1983, 1984, 1985), "1981-1985", 
           ifelse(YEAR %in% c(1986, 1987, 1988, 1989, 1990), "1986-1990",
           ifelse(YEAR %in% c(1991, 1992, 1993, 1994, 1995), "1991-1995",
           ifelse(YEAR %in% c(1996, 1997, 1998, 1999, 2000), "1996-2000",
           ifelse(YEAR %in% c(2001, 2002, 2003, 2004, 2005), "2001-2005",
           ifelse(YEAR %in% c(2006, 2007, 2008, 2009, 2010), "2006-2010",
           ifelse(YEAR %in% c(2011, 2012, 2013, 2014, 2015), "2011-2015",
           ifelse(YEAR %in% c(2016, 2017, 2018, 2019, 2020), "2016-2020", "Error")))))))))))

```


See NAFO zones represented in the hal data from the Mar RV survey data
```{r}
unique(hal_fishTrim$NAFAREA_ID)
```
There are 11 fish where there is no corresponding NAFO (can likely just look it up using the coordinates?)

Reducing the fine scale of NAFO regions to the larger zones (e.g. 4Vs to 4V...) in new column NAFO
```{r}
hal_fishTrim <- hal_fishTrim %>%
  mutate(NAFO = substr(NAFAREA_ID, 1, 2))
```

Graphing the length by weight by larger NAFO zone
```{r}
ggplot(hal_fishTrim, aes(FISH_LENGTH, FISH_WEIGHT)) +
  geom_point()+
  facet_wrap(~NAFO)
```
I am getting some fish outside of our management area (4RST, 3LM, 5Y) do I cut these out???

Graphing the length by weight for year
```{r}
ggplot(hal_fishTrim, aes(FISH_LENGTH, FISH_WEIGHT)) +
  geom_point()+
  facet_wrap(~YEAR)
```

Graphing the length by weight for NAFO and 5yr bins (when colouring the points by sex we lose even more data (from 1188 to 1204 fish not included in the figure below...))
```{r}
ggplot(hal_fishTrim, aes(FISH_LENGTH, FISH_WEIGHT, color = as.factor(SEXCD_ID))) +
  geom_point()+
  scale_color_manual(name = "SEXCD_ID",
                     values = c("0" = "black",
                                  "1" = "blue",
                                  "2" = "deeppink",
                                "NA" = "black"),
  labels = c("0", "male", "female", "NA"))+
  facet_grid(yr_bin~NAFO, scales = "free")
```
This figure above is not super useful but shows where we are missing data by NAFO and year

Graphing NAFO areas within our management area by year to look for when they switched to estimating the weight from measuring it (first looking at the survey)
```{r}
hal_NAFOtrim <- hal_fishTrim %>%
  filter(NAFO %in% c("4X", "4W", "4V", "3P", "3O", "3N", "5Z", NA))

hal_NAFOtrim %>%
  filter(NAFO == "4X", TRIPCD_ID == "7057") %>%
  ggplot() +
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT, color = as.factor(SEXCD_ID))) +
    scale_color_manual(name = "SEXCD_ID",
                     values = c("0" = "black",
                                  "1" = "blue",
                                  "2" = "deeppink",
                                "NA" = "black"),
  labels = c("0", "male", "female", "NA"))+
  facet_wrap(~YEAR)

hal_NAFOtrim %>%
  filter(NAFO == "4W", TRIPCD_ID == "7057") %>%
  ggplot() +
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT, color = as.factor(SEXCD_ID))) +
    scale_color_manual(name = "SEXCD_ID",
                     values = c("0" = "black",
                                  "1" = "blue",
                                  "2" = "deeppink",
                                "NA" = "black"),
  labels = c("0", "male", "female", "NA"))+
  facet_wrap(~YEAR)
  
```


Checking how many fish sampled (that have both length and weight) by year and NAFO
```{r}
NAFO3_4_5_ISDB <- hal_fishTrim %>%
  mutate(NAFO = substr(NAFO,1,1))

#this still includes those fish in 4 and 5 outside our management areas (4RST, 5Y)
num_fish_sampled_ISDB <- data.frame(table(NAFO3_4_5_ISDB$YEAR, NAFO3_4_5_ISDB$NAFO))

#this counts how many fish are in "numb_fish_sampled"
sum(num_fish_sampled_ISDB$Freq)
```

There are 11 fish that do not match up to a NAFO area, could use coordinates to match to a NAFO

Overall there are only 37 weighed fish from 2020, all on TRIPCD_ID 30 (not from survey). 2019 has only weighed fish on survey trips, and all seem to closely follow a log line (likely estimated). Seems like 2016 was the last time in a timeframe where lots of fish had weights and looks like it might have been measured?
```{r}
hal_rmNAwt <- hal_rmNAwt %>%
    mutate(YEAR = substr(BOARD_DATE, 1,4))

hal_rmNAwt %>% count(YEAR)
```

```{r}
hal_rmNAwt %>%
    filter(YEAR == "2016") %>%
   ggplot() +
   geom_point(aes(FISH_LENGTH, FISH_WEIGHT, color = as.factor(SEXCD_ID))) +
   scale_color_manual(name = "SEXCD_ID",
                      values = c("0" = "black",
                                 "1" = "blue",
                                 "2" = "deeppink",
                                 "NA" = "black"),
                      labels = c("0", "male", "female", "NA"))+
   facet_wrap(~SETCD_ID) ##mostly survey trips, lots commercial index
```

Repeating above to pull all halibut from ISDB, not just ones from halibut directed trips
```{r}
hal_allcatch <- ISCATCHES %>%
  filter(SPECCD_ID == "30")
```
```{r}
hal_all <- hal_allcatch %>%
  left_join(ISFISH, by = "CATCH_ID")
unique(hal_all$SPECCD_ID)

hal_all %>% count(SPECCD_ID)
```
Removing rows without length/weight data
```{r}
hal_all %>% count(FISH_LENGTH) # 93,161 observations without length
hal_allrmNAwt <- hal_all %>%
  drop_na(FISH_WEIGHT) #goes from 272,023 observations to 55,197 when weight=NA is removed

hal_allrmNAwt %>% count(FISH_LENGTH) #only 2 fish where there is a weight and no length

```
Finding how/when these halibut were caught by isolating the sets and trips where they were caught
```{r}
hal_allsets <- hal_allrmNAwt %>%
  left_join(ISFISHSETS, by = "FISHSET_ID")

hal_alltrips <- hal_allsets %>%
  left_join(ISTRIPS, by = "TRIP_ID")
```

Removing the port sampled data as discussed 
```{r}
hal_alltrips <- hal_alltrips %>%
  filter(TRIPCD_ID != "7058")
```
Looking at the different types of trips
```{r}
hal_alltrips %>% count(TRIPCD_ID)

trips_halcaught <- hal_alltrips %>%
  left_join(ISTRIPTYPECODES, by = "TRIPCD_ID") %>%
  select("TRIPCD_ID", "TRIP_TYPE") %>%
  count(TRIPCD_ID, TRIP_TYPE)
```

Trimming down the dataframe to useful columns
```{r}
hal_alltrips <- hal_alltrips %>%
  select("TRIP_ID", "TRIP", "TRIPCD_ID", "VESS_ID", "LICENSE_NO", "BOARD_DATE", "LANDING_DATE", "FISHSET_ID", "SET_NO", "SETCD_ID", "SPECSCD_ID.x", "NAFAREA_ID", "CATCH_ID", "SPECCD_ID", "FISH_ID", "FISH_NO", "SEXCD_ID", "FISH_LENGTH", "FISH_WEIGHT", "MATCD_ID", "COMMENTS")
```



Looking into the length and weight data
```{r}
summary(hal_alltrips$FISH_LENGTH)

summary(hal_alltrips$FISH_WEIGHT)
```

Creating some new useful columns
```{r}
hal_alltrips <- hal_alltrips %>%
  mutate(YEAR = substr(BOARD_DATE, 1,4))
  
hal_alltrips <- hal_alltrips %>%
  mutate(NAFO = substr(NAFAREA_ID, 1, 2))
```


Silver hake has the most measured halibut (more than the halibut commercial fishery) only from years 1980-1997, weight appears to be measured in kg and also in g...challenge. 
```{r}
SHhal <- hal_alltrips %>%
  filter(TRIPCD_ID == "14") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE, YEAR)
summary(SHhal)

ggplot(SHhal)+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT))+
  facet_wrap(~YEAR, scales = "free")
```

Next highest measured halibut is in the cod,haddock,pollock fishery, data from 1981-2018, appears to be measured in both kg and g...challenge
```{r}
CHPhal <- hal_alltrips %>%
  filter(TRIPCD_ID == "7001") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE, YEAR, TRIP)
summary(CHPhal)


CHPhal %>% filter(YEAR == "1992") %>%
ggplot()+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT))+
  facet_wrap(~TRIP, scales = "free")
```

Check white hake
```{r}
WHhal <- hal_alltrips %>%
  filter(TRIPCD_ID == "12") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE, YEAR)
summary(WHhal)

ggplot(WHhal)+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT))+
  facet_wrap(~YEAR, scales = "free")
```
Check redfish
```{r}
RFhal <- hal_alltrips %>%
  filter(TRIPCD_ID == "23") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE, YEAR, TRIP)
summary(RFhal)

RFhal %>% filter(YEAR == "1990") %>%
ggplot()+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT))+
  facet_wrap(~TRIP, scales = "free")
```
Check flatfish
```{r}
FFhal <- hal_alltrips %>%
  filter(TRIPCD_ID == "49") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE, YEAR, TRIP)
summary(FFhal)

FFhal %>% filter(YEAR == "1990")
ggplot(FFhal)+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT))+
  facet_wrap(~TRIP, scales = "free")
```

Check skate
```{r}
SKATEhal <- hal_alltrips %>%
  filter(TRIPCD_ID == "211") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE, YEAR, TRIP)
summary(SKATEhal)


ggplot(SKATEhal)+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT))
```
Check mackerel
```{r}
Mackhal <- hal_alltrips %>%
  filter(TRIPCD_ID == "70") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE, YEAR, TRIP)
summary(Mackhal)

ggplot(Mackhal)+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT))
```

Check shrimp
```{r}
shrimphal <- hal_alltrips %>%
  filter(TRIPCD_ID == "2210") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE, YEAR, TRIP)
summary(shrimphal)


ggplot(shrimphal)+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT)) +
  facet_wrap(~TRIP, scales = "free")
```
Check scallop
```{r}
SChal <- hal_alltrips %>%
  filter(TRIPCD_ID == "4320") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE, YEAR, TRIP)
summary(SChal)

ggplot(SChal)+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT))
```
Check squid
```{r}
SQhal <- hal_alltrips %>%
  filter(TRIPCD_ID == "4511") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE, YEAR, TRIP)
summary(SQhal)

ggplot(SQhal)+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT))
```
Check (SH,SQ,Argentine)
```{r}
SSAhal <- hal_alltrips %>%
  filter(TRIPCD_ID == "7002") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE, YEAR, TRIP)
summary(SSAhal)

ggplot(SSAhal)+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT))+
  facet_wrap(~TRIP, scale = "free")
```
Looks like the only trip that might be an issue is redfish trip 90395.0 and it still could be real data...
```{r}
hal_alltrips %>% filter(TRIP == "90395.0") %>%
  ggplot()+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT))
```



Looking at the data that comes from surveys: 4VsW Sentinel Program (n=775), 4X Mobile Gear Survey (n=547), 4VXW Skate Survey (n=1), 5Z Fixed Gear Survey (n=1), GEAC Juv. and Forage Survey (n=26), Snowcrab Survey (n=15)
```{r}
allsurveyhal <- hal_alltrips %>%
  filter(TRIPCD_ID %in% c("7050", "7051", "7054", "7055", "7060", "7061"))

Sentinel <- allsurveyhal %>%
  filter(TRIPCD_ID == "7050") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE)
summary(Sentinel) #data looks somewhat consistent and potentially useful. Length appears cm, weight appears all g. Range from 1995-2019

MGS <- allsurveyhal %>%
  filter(TRIPCD_ID == "7051") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE)
summary(MGS) #data looks somewhat consistent and potentially useful. Length appears cm, weight appears all g. Range from 1998-2012

GEAC_juv <- allsurveyhal %>%
  filter(TRIPCD_ID == "7060") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE)
summary(GEAC_juv) #few fish (n=26), weight appears to be g and length appearsa to be cm. Range from 2002-2003

snowcrab <- allsurveyhal %>%
  filter(TRIPCD_ID == "7061") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE)
summary(snowcrab) #few data (n=15), weight appears to be g, length appears to be cm. range from 2015-2020.

others <- allsurveyhal %>%
  filter(TRIPCD_ID %in% c("7055", "7054")) %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE)
print(others) #these are the two fish that were measured for length and weight in the 4VWX skate survey and the 5Z fixed gear survey

```
Need to make a decision on what to keep from this data in addition to the halibut directed
```{r}
ggplot(hal_alltrips) +
  geom_histogram(aes(YEAR), stat = "count") +
  facet_wrap(~NAFO, scales = "free")

```
This tells me there are data from the other fisheries/surveys that are outside our management unit. I need to remove those. And there are 9 fish where NAFO is not identified (tripcd_ID for missing NAFO is "J09-0307", set #1, FISHSET_ID = 100159262...can pull coordinates for that)
```{r}
hal_allNAFOfilter[is.na(hal_allNAFOfilter$NAFO),]

ISSETPROFILE_WIDE %>%
  filter(FISHSET_ID == 100159262) #(LAT1: 42.771, LONG1:-63.352...looks like 4X, will map to ensure)
```

Removing data from outside our management unit (keeping 3NOP4VWX5YZ and NA)
```{r}
hal_allNAFOfilter <- hal_alltrips %>%
  filter(NAFO %in% c("3N", "3O", "3P", "4V", "4W", "4X", "5Y", "5Z", NA))

ggplot(hal_allNAFOfilter) +
  geom_histogram(aes(YEAR), stat = "count") +
  facet_wrap(~NAFO, scales = "free")
```
Looking at the range/scale of data
```{r}
ggplot(hal_allNAFOfilter) +
  geom_histogram(aes(FISH_WEIGHT), binwidth = 200)

#this plot below shows some of the fish that are an issue (the ones along the curve are weighed in kg presumably)
hal_allNAFOfilter %>%
  filter(FISH_WEIGHT < 250) %>%
  ggplot(aes(FISH_LENGTH, FISH_WEIGHT, label=TRIP))+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT, label=TRIP))+
  geom_text(aes(label=ifelse(FISH_LENGTH>45, as.character(TRIP), ' ')),position=position_jitter(width=1,height=1)) #(if I want the points with length <50 labeled by trip)


somekgtrips <- hal_allNAFOfilter %>%
  filter(FISH_WEIGHT < 200) %>%
  filter(FISH_LENGTH > 50) #trying to figure out the bounds for this...looks like there are fish around 200g that might be correctly recorded in grams (the bunch close to the almost verticle line) the group below that also appear to be fish of small size around 150g
#For trip J11-0074 It looks to me that either weight or length was copied into both columns except for fish id = 102197700 which appears to be in kg (accounts for most of the group above the log curve)
#For trip J18-0211 it appears that one weight was copied for all fish in that set (and it's a weight that doesn't make sense in g or kg...)
#the rest appear to be simple kg vs. g issues

unique(somekgtrips$TRIP)

```
Can get Gabrielle to at least check the trips that were in the survey (or maybe just the ones from 2018?)

Difference in amount of data between all halibut in ISDB and all halibut from directed trips = 14,891 more halibut when considering all the data...although there are some limitations (unknown how these data are recorded, issues with units...)

Removing outliers from all hal data (NEED TO MAKE A AND B BEFORE RUNNING THIS ON TOTAL DATA SET...THIS IS JUST TO TEST THE CODE)
```{r}
library(sqldf)

test_hal <- hal_allNAFOfilter %>%
  select(FISH_ID, FISH_LENGTH, FISH_WEIGHT, TRIP, TRIPCD_ID)

test_hal$out<-0
test_hal<-test_hal[!is.na(test_hal$FISH_LENGTH),]
test_hal<-test_hal[!is.na(test_hal$FISH_WEIGHT),]

#identify outliers (using a and b from the previous assessment log(a)=-5.021354 so a=0.00659559; b=3.124184)
mod1<-nls(FISH_WEIGHT~a*FISH_LENGTH^b,data=test_hal,start=c(a=0.00659559,b=3.124184),na.action=na.omit) #these results are the same with a=0.001 and b=3 as was used by nell in her getLW function from the previous assessment
test_hal$upper<-predict(mod1, list(FISH_LENGTH = test_hal$FISH_LENGTH))*1.75
test_hal$lower<-predict(mod1, list(FISH_LENGTH = test_hal$FISH_LENGTH))*0.25
test_hal$out[test_hal$FISH_WEIGHT<test_hal$upper&test_hal$FISH_WEIGHT>test_hal$lower]<-1
test_lenwt.dat.all<-test_hal[,c(1:8)]

ISDB_outliers <- test_lenwt.dat.all %>% filter(out == "0") #here we lose 319 fish as outliers (not major at all in the overall dataset, it's 0.58%) 
test_full <- test_lenwt.dat.all %>% filter(out == "1") #still 4,300+ small fish!

test_full %>%
  filter(FISH_WEIGHT < 250) %>%
  ggplot(aes(FISH_LENGTH, FISH_WEIGHT))+
  geom_point()
#the problem seen above where issues arose due to kg vs. g units is not seen here, these data seem cleaned

ggplot(test_full, aes(FISH_LENGTH, FISH_WEIGHT))+
  geom_point()

# test_full %>% filter(between(FISH_LENGTH, 175, 200), between(FISH_WEIGHT, 20000, 21000)) %>%
# ggplot(aes(FISH_LENGTH, FISH_WEIGHT, label=TRIP))+
#   geom_point()+
#   geom_text(aes(label=as.character(TRIP)))#outliers have been removed and data appear far more clean
```





