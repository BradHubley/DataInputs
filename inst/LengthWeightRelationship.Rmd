---
title: "Length Weight Relationship"
author: "Danni"
date: "February 16, 2021"
output: html_document
--- 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
 library(Mar.datawrangling)
 library(tidyverse)
 library(lubridate)
 library(stringr)

#datadir="C:/Users/harperd/Documents/Halibut/RDataVault"
#wd="C:/Users/harperd/Documents/Halibut/GitDataInputs/DataInputs/"
source(file.path(wd, ".passwords"))

```

Extract MAR RV survey data using RORACLE
```{r}
#get_data("rv", data.dir = "C:/Users/harperd/Documents/Halibut/RDataVault/", usepkg = "roracle",fn.oracle.username = "hubleyb", fn.oracle.password = "R4#vmxtas", fn.oracle.dsn = "PTRAN", force.extract = T)
```

Extract MAR RV survey data from existing dump
```{r}
get_data("rv", data.dir = datadir)
```

Pull halibut morphology data from the MAR RV survey since beginning of survey data set (1970?)
```{r}
hal <- GSDET %>%
  filter(SPEC == "30")
```

Scatter plot of Length and Weight of halibut from RV survey
```{r}
ggplot(hal, aes(FLEN, FWT)) +
  geom_point()
```
There are 1188 fish that have no weights associated with the lengths in the MAR RV survey data

Combining the hal data with the set info to determine strata
```{r}
setdata_halRV <- merge(hal, GSINF, by.x = c("MISSION","SETNO"), 
                       by.y = c("MISSION","SETNO"), all.x = TRUE, all.y = FALSE) %>% 
  select("MISSION", "SETNO", "SPEC", "FSHNO", "FLEN", "FSEX", "FMAT", "FWT", "AGMAT", "AGE", "CLEN", "REMARKS.x", "SIZE_CLASS", "SDATE", "STRAT", "SLAT", "SLONG", "ELAT", "ELONG", "ETIME", "REMARKS.y", "START_DEPTH", "END_DEPTH", "SURFACE_TEMPERATURE", "BOTTOM_TEMPERATURE", "BOTTOM_SALINITY", "STATION")
```

Joining the Stratum table to attach associated NAFO info
```{r}
setdata_halRV <- setdata_halRV %>%
  left_join(GSSTRATUM, by = "STRAT") %>%
  select(-"DMIN", -"DMAX", -"AREA", -"DEPTH")
```

Create year column and column of 5yr bins starting in 1970
```{r}
setdata_halRV <- setdata_halRV %>%
  mutate(YEAR = substr(SDATE, 1,4))

setdata_halRV <- setdata_halRV %>%
  mutate(yr_bin = 
           ifelse(YEAR %in% c(1970, 1971, 1972, 1973, 1974, 1975), "1970-1975", 
           ifelse(YEAR %in% c(1976, 1977, 1978, 1979, 1980), "1976-1980",
           ifelse(YEAR %in% c(1981, 1982, 1983, 1984, 1985), "1981-1985", 
           ifelse(YEAR %in% c(1986, 1987, 1988, 1989, 1990), "1986-1990",
           ifelse(YEAR %in% c(1991, 1992, 1993, 1994, 1995), "1991-1995",
           ifelse(YEAR %in% c(1996, 1997, 1998, 1999, 2000), "1996-2000",
           ifelse(YEAR %in% c(2001, 2002, 2003, 2004, 2005), "2001-2005",
           ifelse(YEAR %in% c(2006, 2007, 2008, 2009, 2010), "2006-2010",
           ifelse(YEAR %in% c(2011, 2012, 2013, 2014, 2015), "2011-2015",
           ifelse(YEAR %in% c(2016, 2017, 2018, 2019, 2020), "2016-2020", "Error")))))))))))

```


See NAFO zones represented in the hal data from the Mar RV survey data
```{r}
unique(setdata_halRV$NAME)
```
There are 10 fish where there is no corresponding NAFO (can likely just look it up using the coordinates?)

Reducing the fine scale of NAFO regions to the larger zones (e.g. 4Vs to 4V...) in new column NAFO
```{r}
setdata_halRV <- setdata_halRV %>%
  mutate(NAFO = substr(NAME, 1, 2))
```

Graphing the length by weight by larger NAFO zone
```{r}
ggplot(setdata_halRV, aes(FLEN, FWT)) +
  geom_point()+
  facet_wrap(~NAFO)
```
Graphing the length by weight for NAFO and year
```{r}
ggplot(setdata_halRV, aes(FLEN, FWT)) +
  geom_point()+
  facet_grid(YEAR~NAFO)
```

Graphing the length by weight for NAFO and 5yr bins (when colouring the points by sex we lose even more data (from 1188 to 1204 fish not included in the figure below...))
```{r}
ggplot(setdata_halRV, aes(FLEN, FWT, color = as.factor(FSEX))) +
  geom_point()+
  scale_color_manual(name = "FSEX",
                     values = c("0" = "black",
                                  "1" = "blue",
                                  "2" = "deeppink",
                                "NA" = "black"),
  labels = c("0", "male", "female", "NA"))+
  facet_grid(yr_bin~NAFO, scales = "free")
```
Checking how many fish sampled by year and NAFO
```{r}
NAFO_4_5 <- setdata_halRV %>%
  mutate(NAFO = substr(NAFO,1,1))


num_fish_sampled <- data.frame(table(NAFO_4_5$YEAR, NAFO_4_5$NAFO))

#this counts how many fish are in "numb_fish_sampled"
sum(num_fish_sampled$Freq)
```
There are 10 fewer fish in num_fish_sampled than in setdata_RVhal because 10 fish in the original data don't have an associated NAFO zone

Many of these don't match up for NAFO and year...(how is the data so different?)


