---
title: "Length Weight Relationship"
author: "Danni"
date: "February 16, 2021"
output: html_document
--- 

---packages and data directory set up
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
 library(Mar.datawrangling)
 library(tidyverse)
 library(lubridate)
 library(stringr)

datadir="C:/Users/harperd/Documents/Halibut/RDataVault"
wd="C:/Users/harperd/Documents/Halibut/GitDataInputs/DataInputs/"
source(file.path(wd, "passwords.r"))
```

---Extract MAR RV survey data using RORACLE
```{r}
#get_data("rv", data.dir = "C:/Users/harperd/Documents/Halibut/RDataVault/", usepkg = "roracle",fn.oracle.username = "hubleyb", fn.oracle.password = "R4#vmxtas", fn.oracle.dsn = "PTRAN", force.extract = T)
```

Extract MAR RV survey data from existing dump
```{r}
get_data("rv", data.dir = datadir)
```

Pull halibut morphology data from the MAR RV survey since beginning of survey data set (1970?)
```{r}
hal <- GSDET %>%
  filter(SPEC == "30")
```

Scatter plot of Length and Weight of halibut from RV survey
```{r}
ggplot(hal, aes(FLEN, FWT)) +
  geom_point()
```
There are 1188 fish that have no weights associated with the lengths in the MAR RV survey data

Combining the hal data with the set info to determine strata
```{r}
setdata_halRV <- merge(hal, GSINF, by.x = c("MISSION","SETNO"), 
                       by.y = c("MISSION","SETNO"), all.x = TRUE, all.y = FALSE) %>% 
  select("MISSION", "SETNO", "SPEC", "FSHNO", "FLEN", "FSEX", "FMAT", "FWT", "AGMAT", "AGE", "CLEN", "REMARKS.x", "SIZE_CLASS", "SDATE", "STRAT", "SLAT", "SLONG", "ELAT", "ELONG", "ETIME", "REMARKS.y", "START_DEPTH", "END_DEPTH", "SURFACE_TEMPERATURE", "BOTTOM_TEMPERATURE", "BOTTOM_SALINITY", "STATION")
```

Joining the Stratum table to attach associated NAFO info
```{r}
setdata_halRV <- setdata_halRV %>%
  left_join(GSSTRATUM, by = "STRAT") %>%
  select(-"DMIN", -"DMAX", -"AREA", -"DEPTH")
```

Create year column and column of 5yr bins starting in 1970
```{r}
setdata_halRV <- setdata_halRV %>%
  mutate(YEAR = substr(SDATE, 1,4))

setdata_halRV <- setdata_halRV %>%
  mutate(yr_bin = 
           ifelse(YEAR %in% c(1970, 1971, 1972, 1973, 1974, 1975), "1970-1975", 
           ifelse(YEAR %in% c(1976, 1977, 1978, 1979, 1980), "1976-1980",
           ifelse(YEAR %in% c(1981, 1982, 1983, 1984, 1985), "1981-1985", 
           ifelse(YEAR %in% c(1986, 1987, 1988, 1989, 1990), "1986-1990",
           ifelse(YEAR %in% c(1991, 1992, 1993, 1994, 1995), "1991-1995",
           ifelse(YEAR %in% c(1996, 1997, 1998, 1999, 2000), "1996-2000",
           ifelse(YEAR %in% c(2001, 2002, 2003, 2004, 2005), "2001-2005",
           ifelse(YEAR %in% c(2006, 2007, 2008, 2009, 2010), "2006-2010",
           ifelse(YEAR %in% c(2011, 2012, 2013, 2014, 2015), "2011-2015",
           ifelse(YEAR %in% c(2016, 2017, 2018, 2019, 2020), "2016-2020", "Error")))))))))))

```


See NAFO zones represented in the hal data from the Mar RV survey data
```{r}
unique(setdata_halRV$NAME)
```
There are 10 fish where there is no corresponding NAFO (can likely just look it up using the coordinates?)

Reducing the fine scale of NAFO regions to the larger zones (e.g. 4Vs to 4V...) in new column NAFO
```{r}
setdata_halRV <- setdata_halRV %>%
  mutate(NAFO = substr(NAME, 1, 2))
```

Graphing the length by weight by larger NAFO zone
```{r}
ggplot(setdata_halRV, aes(FLEN, FWT)) +
  geom_point()+
  facet_wrap(~NAFO)
```
Graphing the length by weight for NAFO and year
```{r}
ggplot(setdata_halRV, aes(FLEN, FWT)) +
  geom_point()+
  facet_grid(YEAR~NAFO)
```

Graphing the length by weight for NAFO and 5yr bins (when colouring the points by sex we lose even more data (from 1188 to 1204 fish not included in the figure below...))
```{r}
ggplot(setdata_halRV, aes(FLEN, FWT, color = as.factor(FSEX))) +
  geom_point()+
  scale_color_manual(name = "FSEX",
                     values = c("0" = "black",
                                  "1" = "blue",
                                  "2" = "deeppink",
                                "NA" = "black"),
  labels = c("0", "male", "female", "NA"))+
  facet_grid(yr_bin~NAFO, scales = "free")
```
Checking how many fish sampled by year and NAFO
```{r}
NAFO_4_5 <- setdata_halRV %>%
  mutate(NAFO = substr(NAFO,1,1))


num_fish_sampled <- data.frame(table(NAFO_4_5$YEAR, NAFO_4_5$NAFO))

#this counts how many fish are in "numb_fish_sampled"
sum(num_fish_sampled$Freq)
```
There are 10 fewer fish in num_fish_sampled than in setdata_RVhal because 10 fish in the original data don't have an associated NAFO zone

Many of these don't match up for NAFO and year...(how is the data so different?)

Looking at the 1188 missing data...
```{r}
setdata_halRV[is.na(setdata_halRV$FLEN),]

setdata_halRV[is.na(setdata_halRV$FWT),] #there are 1188 fish missing weights
```


---Extract ISDB data using RORACLE
```{r}
#get_data("isdb", data.dir = "C:/Users/harperd/Documents/Halibut/RDataVault/", usepkg = "roracle",fn.oracle.username = "hubleyb", fn.oracle.password = "R4#vmxtas", fn.oracle.dsn = "PTRAN", force.extract = T)
```

Pull ISDB data from where it is stored locally (previously pulled from database using oracle)
```{r}
get_data("isdb", data.dir = datadir)
```

Pulling the halibut trips from the trips table (30 = halibut, 7057 = halibut longline survey, 7058 = halibut port sampling)
```{r}
hal_trips <- ISTRIPS %>%
  filter(TRIPCD_ID %in% c("30", "7057"))
```

Pulling all the sets that belong to the halibut trips identified above
```{r}
hal_fishsets <- hal_trips %>%
  left_join(ISFISHSETS, by = "TRIP_ID") %>%
  drop_na(FISHSET_ID) #need to drop NAs as there are 281 catches with NA for fish set in ISCATCHED that are being matched in the next join
```

Pulling out all the catches from the identified sets above
```{r}
hal_catches <- hal_fishsets %>%
  left_join(ISCATCHES, by = "FISHSET_ID")
```
**Weird that for species sought there are other species (30, 12, 15, 7099, 31, 23, 11, 10, 211, 201, 16, NA) even though the trip is identified as trip code 30...should I be isolating for only halibut sought trips???


Pulling out all fish caught in the catches from the halibut trips, and then filtering for just the halibut caught
```{r}
hal_fish <- hal_catches %>%
  left_join(ISFISH, by = "CATCH_ID") %>%
  filter(SPECCD_ID == "30")
```

First exploratory plot: plotting all length against width (some will not be plotted and provides idea of how many individuals are missing a length or weight measurement)
```{r}
ggplot(hal_fish, aes(FISH_LENGTH, FISH_WEIGHT)) +
  geom_point()
```
From looking at the data in hal_fish and the graph there are A LOT of issues: lots of missing lengths and weights, and weights that don't make sense (what's the units for the weights?)
```{r}
hal_fish %>% 
  count(FISH_LENGTH) # 10,949 rows without fish length (of these, 2 have weights and the rest are missing both)

hal_rmNAwt <- hal_fish %>%
  drop_na(FISH_WEIGHT)#from 180,684 observations in hal_fish to 40,256 observations where weight is available
```

Trimming down the dataframe to useful columns
```{r}
hal_fishTrim <- hal_rmNAwt %>%
  select("TRIP_ID", "TRIP", "TRIPCD_ID", "VESS_ID", "LICENSE_NO", "BOARD_DATE", "LANDING_DATE", "FISHSET_ID", "SET_NO", "SETCD_ID", "SPECSCD_ID.x", "NAFAREA_ID", "CATCH_ID", "SPECCD_ID", "FISH_ID", "FISH_NO", "SEXCD_ID", "FISH_LENGTH", "FISH_WEIGHT", "MATCD_ID", "COMMENTS")
```

Create year column and column of 5yr bins starting in 1970
```{r}
hal_fishTrim <- hal_fishTrim %>%
  mutate(YEAR = substr(BOARD_DATE, 1,4)) #all rows have a board date, but some don't have a land date

hal_fishTrim <- hal_fishTrim %>%
  mutate(yr_bin = 
           ifelse(YEAR %in% c(1970, 1971, 1972, 1973, 1974, 1975), "1970-1975", 
           ifelse(YEAR %in% c(1976, 1977, 1978, 1979, 1980), "1976-1980",
           ifelse(YEAR %in% c(1981, 1982, 1983, 1984, 1985), "1981-1985", 
           ifelse(YEAR %in% c(1986, 1987, 1988, 1989, 1990), "1986-1990",
           ifelse(YEAR %in% c(1991, 1992, 1993, 1994, 1995), "1991-1995",
           ifelse(YEAR %in% c(1996, 1997, 1998, 1999, 2000), "1996-2000",
           ifelse(YEAR %in% c(2001, 2002, 2003, 2004, 2005), "2001-2005",
           ifelse(YEAR %in% c(2006, 2007, 2008, 2009, 2010), "2006-2010",
           ifelse(YEAR %in% c(2011, 2012, 2013, 2014, 2015), "2011-2015",
           ifelse(YEAR %in% c(2016, 2017, 2018, 2019, 2020), "2016-2020", "Error")))))))))))

```


See NAFO zones represented in the hal data from the Mar RV survey data
```{r}
unique(hal_fishTrim$NAFAREA_ID)
```
There are 11 fish where there is no corresponding NAFO (can likely just look it up using the coordinates?)

Reducing the fine scale of NAFO regions to the larger zones (e.g. 4Vs to 4V...) in new column NAFO
```{r}
hal_fishTrim <- hal_fishTrim %>%
  mutate(NAFO = substr(NAFAREA_ID, 1, 2))
```

Graphing the length by weight by larger NAFO zone
```{r}
ggplot(hal_fishTrim, aes(FISH_LENGTH, FISH_WEIGHT)) +
  geom_point()+
  facet_wrap(~NAFO)
```
I am getting some fish outside of our management area (4RST, 3LM, 5Y) do I cut these out???

Graphing the length by weight for year
```{r}
ggplot(hal_fishTrim, aes(FISH_LENGTH, FISH_WEIGHT)) +
  geom_point()+
  facet_wrap(~YEAR)
```

Graphing the length by weight for NAFO and 5yr bins (when colouring the points by sex we lose even more data (from 1188 to 1204 fish not included in the figure below...))
```{r}
ggplot(hal_fishTrim, aes(FISH_LENGTH, FISH_WEIGHT, color = as.factor(SEXCD_ID))) +
  geom_point()+
  scale_color_manual(name = "SEXCD_ID",
                     values = c("0" = "black",
                                  "1" = "blue",
                                  "2" = "deeppink",
                                "NA" = "black"),
  labels = c("0", "male", "female", "NA"))+
  facet_grid(yr_bin~NAFO, scales = "free")
```
This figure above is not super useful but shows where we are missing data by NAFO and year

Graphing NAFO areas within our management area by year to look for when they switched to estimating the weight from measuring it (first looking at the survey)
```{r}
hal_NAFOtrim <- hal_fishTrim %>%
  filter(NAFO %in% c("4X", "4W", "4V", "3P", "3O", "3N", "5Z", NA))

hal_NAFOtrim %>%
  filter(NAFO == "4X", TRIPCD_ID == "7057") %>%
  ggplot() +
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT, color = as.factor(SEXCD_ID))) +
    scale_color_manual(name = "SEXCD_ID",
                     values = c("0" = "black",
                                  "1" = "blue",
                                  "2" = "deeppink",
                                "NA" = "black"),
  labels = c("0", "male", "female", "NA"))+
  facet_wrap(~YEAR)

hal_NAFOtrim %>%
  filter(NAFO == "4W", TRIPCD_ID == "7057") %>%
  ggplot() +
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT, color = as.factor(SEXCD_ID))) +
    scale_color_manual(name = "SEXCD_ID",
                     values = c("0" = "black",
                                  "1" = "blue",
                                  "2" = "deeppink",
                                "NA" = "black"),
  labels = c("0", "male", "female", "NA"))+
  facet_wrap(~YEAR)
  
```


Checking how many fish sampled (that have both length and weight) by year and NAFO
```{r}
NAFO3_4_5_ISDB <- hal_fishTrim %>%
  mutate(NAFO = substr(NAFO,1,1))

#this still includes those fish in 4 and 5 outside our management areas (4RST, 5Y)
num_fish_sampled_ISDB <- data.frame(table(NAFO3_4_5_ISDB$YEAR, NAFO3_4_5_ISDB$NAFO))

#this counts how many fish are in "numb_fish_sampled"
sum(num_fish_sampled_ISDB$Freq)
```

There are 11 fish that do not match up to a NAFO area, could use coordinates to match to a NAFO

Overall there are only 37 weighed fish from 2020, all on TRIPCD_ID 30 (not from survey). 2019 has only weighed fish on survey trips, and all seem to closely follow a log line (likely estimated). Seems like 2016 was the last time in a timeframe where lots of fish had weights and looks like it might have been measured?
```{r}
hal_rmNAwt <- hal_rmNAwt %>%
    mutate(YEAR = substr(BOARD_DATE, 1,4))

hal_rmNAwt %>% count(YEAR)
```

```{r}
hal_rmNAwt %>%
    filter(YEAR == "2016") %>%
   ggplot() +
   geom_point(aes(FISH_LENGTH, FISH_WEIGHT, color = as.factor(SEXCD_ID))) +
   scale_color_manual(name = "SEXCD_ID",
                      values = c("0" = "black",
                                 "1" = "blue",
                                 "2" = "deeppink",
                                 "NA" = "black"),
                      labels = c("0", "male", "female", "NA"))+
   facet_wrap(~SETCD_ID) ##mostly survey trips, lots commercial index
```


#----Repeating above to pull all halibut from ISDB, not just ones from halibut directed trips----
```{r}
hal_allcatch <- ISCATCHES %>%
  filter(SPECCD_ID == "30")
```
```{r}
hal_all <- hal_allcatch %>%
  left_join(ISFISH, by = "CATCH_ID")
unique(hal_all$SPECCD_ID)

hal_all %>% count(SPECCD_ID)
```
Removing rows without length/weight data
```{r}
hal_all %>% count(FISH_LENGTH) # 93,161 observations without length
hal_allrmNAwt <- hal_all %>%
  drop_na(FISH_WEIGHT) #goes from 272,023 observations to 55,197 when weight=NA is removed

hal_allrmNAwt %>% count(FISH_LENGTH) #only 2 fish where there is a weight and no length

```
Finding how/when these halibut were caught by isolating the sets and trips where they were caught
```{r}
hal_allsets <- hal_allrmNAwt %>%
  left_join(ISFISHSETS, by = "FISHSET_ID")

hal_allLATLONG <- ISSETPROFILE_WIDE %>% select(FISHSET_ID, LAT1, LONG1, LAT2, LONG2, LAT3, LONG3, LAT4, LONG4)
  
hal_allsetinfo <- hal_allsets %>%
  left_join(hal_allLATLONG, by = "FISHSET_ID")

hal_alltrips <- hal_allsetinfo %>%
  left_join(ISTRIPS, by = "TRIP_ID")

```

Removing the port sampled data as discussed 
```{r}
hal_alltrips <- hal_alltrips %>%
  filter(TRIPCD_ID != "7058")
```
Looking at the different types of trips
```{r}
hal_alltrips %>% count(TRIPCD_ID)

trips_halcaught <- hal_alltrips %>%
  left_join(ISTRIPTYPECODES, by = "TRIPCD_ID") %>%
  select("TRIPCD_ID", "TRIP_TYPE") %>%
  count(TRIPCD_ID, TRIP_TYPE)
```

Trimming down the dataframe to useful columns
```{r}
hal_alltrips <- hal_alltrips %>%
  select("TRIP_ID", "TRIP", "TRIPCD_ID", "VESS_ID", "LICENSE_NO", "BOARD_DATE", "LANDING_DATE", "FISHSET_ID", "SET_NO", "SETCD_ID", "SPECSCD_ID.x", "NAFAREA_ID", "CATCH_ID", "SPECCD_ID", "FISH_ID", "FISH_NO", "SEXCD_ID", "FISH_LENGTH", "FISH_WEIGHT", "MATCD_ID", "COMMENTS", "LAT1", "LONG1", "LAT2", "LONG2", "LAT3", "LONG3", "LAT4", "LONG4")
```



Looking into the length and weight data
```{r}
summary(hal_alltrips$FISH_LENGTH)

summary(hal_alltrips$FISH_WEIGHT)
```

Creating some new useful columns
```{r}
hal_alltrips <- hal_alltrips %>%
  mutate(YEAR = substr(BOARD_DATE, 1,4))
  
hal_alltrips <- hal_alltrips %>%
  mutate(NAFO = substr(NAFAREA_ID, 1, 2))
```


Silver hake has the most measured halibut (more than the halibut commercial fishery) only from years 1980-1997, weight appears to be measured in kg and also in g...challenge. 
```{r}
SHhal <- hal_alltrips %>%
  filter(TRIPCD_ID == "14") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE, YEAR, NAFO)
summary(SHhal)

ggplot(SHhal)+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT))+
  facet_wrap(~NAFO, scales = "free")
```

Next highest measured halibut is in the cod,haddock,pollock fishery, data from 1981-2018, appears to be measured in both kg and g...challenge
```{r}
CHPhal <- hal_alltrips %>%
  filter(TRIPCD_ID == "7001") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE, YEAR, TRIP)
summary(CHPhal)


CHPhal %>% filter(YEAR == "1992") %>%
ggplot()+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT))+
  facet_wrap(~TRIP, scales = "free")
```

Check white hake
```{r}
WHhal <- hal_alltrips %>%
  filter(TRIPCD_ID == "12") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE, YEAR)
summary(WHhal)

ggplot(WHhal)+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT))+
  facet_wrap(~YEAR, scales = "free")
```
Check redfish
```{r}
RFhal <- hal_alltrips %>%
  filter(TRIPCD_ID == "23") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE, YEAR, TRIP)
summary(RFhal)

RFhal %>% filter(YEAR == "1990") %>%
ggplot()+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT))+
  facet_wrap(~TRIP, scales = "free")
```
Check flatfish
```{r}
FFhal <- hal_alltrips %>%
  filter(TRIPCD_ID == "49") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE, YEAR, TRIP)
summary(FFhal)

FFhal %>% filter(YEAR == "1990")
ggplot(FFhal)+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT))+
  facet_wrap(~TRIP, scales = "free")
```

Check skate
```{r}
SKATEhal <- hal_alltrips %>%
  filter(TRIPCD_ID == "211") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE, YEAR, TRIP)
summary(SKATEhal)


ggplot(SKATEhal)+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT))
```
Check mackerel
```{r}
Mackhal <- hal_alltrips %>%
  filter(TRIPCD_ID == "70") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE, YEAR, TRIP)
summary(Mackhal)

ggplot(Mackhal)+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT))
```

Check shrimp
```{r}
shrimphal <- hal_alltrips %>%
  filter(TRIPCD_ID == "2210") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE, YEAR, TRIP)
summary(shrimphal)


ggplot(shrimphal)+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT)) +
  facet_wrap(~TRIP, scales = "free")
```
Check scallop
```{r}
SChal <- hal_alltrips %>%
  filter(TRIPCD_ID == "4320") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE, YEAR, TRIP)
summary(SChal)

ggplot(SChal)+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT))
```
Check squid
```{r}
SQhal <- hal_alltrips %>%
  filter(TRIPCD_ID == "4511") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE, YEAR, TRIP)
summary(SQhal)

ggplot(SQhal)+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT))
```
Check (SH,SQ,Argentine)
```{r}
SSAhal <- hal_alltrips %>%
  filter(TRIPCD_ID == "7002") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE, YEAR, TRIP)
summary(SSAhal)

ggplot(SSAhal)+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT))+
  facet_wrap(~TRIP, scale = "free")
```
Looks like the only trip that might be an issue is redfish trip 90395.0 and it still could be real data...
```{r}
hal_alltrips %>% filter(TRIP == "90395.0") %>%
  ggplot()+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT))
```



Looking at the data that comes from surveys: 4VsW Sentinel Program (n=775), 4X Mobile Gear Survey (n=547), 4VXW Skate Survey (n=1), 5Z Fixed Gear Survey (n=1), GEAC Juv. and Forage Survey (n=26), Snowcrab Survey (n=15)
```{r}
allsurveyhal <- hal_alltrips %>%
  filter(TRIPCD_ID %in% c("7050", "7051", "7054", "7055", "7060", "7061"))

Sentinel <- allsurveyhal %>%
  filter(TRIPCD_ID == "7050") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE)
summary(Sentinel) #data looks somewhat consistent and potentially useful. Length appears cm, weight appears all g. Range from 1995-2019

MGS <- allsurveyhal %>%
  filter(TRIPCD_ID == "7051") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE)
summary(MGS) #data looks somewhat consistent and potentially useful. Length appears cm, weight appears all g. Range from 1998-2012

GEAC_juv <- allsurveyhal %>%
  filter(TRIPCD_ID == "7060") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE)
summary(GEAC_juv) #few fish (n=26), weight appears to be g and length appearsa to be cm. Range from 2002-2003

snowcrab <- allsurveyhal %>%
  filter(TRIPCD_ID == "7061") %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE)
summary(snowcrab) #few data (n=15), weight appears to be g, length appears to be cm. range from 2015-2020.

others <- allsurveyhal %>%
  filter(TRIPCD_ID %in% c("7055", "7054")) %>%
  select(FISH_LENGTH, FISH_WEIGHT, BOARD_DATE)
print(others) #these are the two fish that were measured for length and weight in the 4VWX skate survey and the 5Z fixed gear survey

```
Need to make a decision on what to keep from this data in addition to the halibut directed
```{r}
ggplot(hal_alltrips) +
  geom_histogram(aes(YEAR), stat = "count") +
  facet_wrap(~NAFO, scales = "free")

```
This tells me there are data from the other fisheries/surveys that are outside our management unit. I need to remove those. And there are 9 fish where NAFO is not identified (tripcd_ID for missing NAFO is "J09-0307", set #1, FISHSET_ID = 100159262...can pull coordinates for that)
```{r}
hal_allNAFOfilter[is.na(hal_allNAFOfilter$NAFO),]

ISSETPROFILE_WIDE %>%
  filter(FISHSET_ID == 100159262) #(LAT1: 42.771, LONG1:-63.352...looks like 4X, will map to ensure)
```

Removing data from outside our management unit (keeping 3NOP4VWX5YZ and NA)
```{r}
hal_allNAFOfilter <- hal_alltrips %>%
  filter(NAFO %in% c("3N", "3O", "3P", "4V", "4W", "4X", "5Y", "5Z", NA))

ggplot(hal_allNAFOfilter) +
  geom_histogram(aes(YEAR), stat = "count") +
  facet_wrap(~NAFO, scales = "free")
```
Looking at the range/scale of data
```{r}
ggplot(hal_allNAFOfilter) +
  geom_histogram(aes(FISH_WEIGHT), binwidth = 200)

#this plot below shows some of the fish that are an issue (the ones along the curve are weighed in kg presumably)
hal_allNAFOfilter %>%
  filter(FISH_WEIGHT < 250) %>%
  ggplot(aes(FISH_LENGTH, FISH_WEIGHT, label=TRIP))+
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT, label=TRIP))+
  geom_text(aes(label=ifelse(FISH_LENGTH>45, as.character(TRIP), ' ')),position=position_jitter(width=1,height=1)) #(if I want the points with length <50 labeled by trip)


somekgtrips <- hal_allNAFOfilter %>%
  filter(FISH_WEIGHT < 200) %>%
  filter(FISH_LENGTH > 50) #trying to figure out the bounds for this...looks like there are fish around 200g that might be correctly recorded in grams (the bunch close to the almost verticle line) the group below that also appear to be fish of small size around 150g
#For trip J11-0074 It looks to me that either weight or length was copied into both columns except for fish id = 102197700 which appears to be in kg (accounts for most of the group above the log curve)
#For trip J18-0211 it appears that one weight was copied for all fish in that set (and it's a weight that doesn't make sense in g or kg...)
#the rest appear to be simple kg vs. g issues

unique(somekgtrips$TRIP)

```
Can get Gabrielle to at least check the trips that were in the survey (or maybe just the ones from 2018?)

Difference in amount of data between all halibut in ISDB and all halibut from directed trips = 14,891 more halibut when considering all the data...although there are some limitations (unknown how these data are recorded, issues with units...)

Removing outliers from all hal data (NEED TO MAKE A AND B BEFORE RUNNING THIS ON TOTAL DATA SET...THIS IS JUST TO TEST THE CODE)
```{r}
# library(sqldf)
# 
# test_hal <- hal_allNAFOfilter %>%
#   select(FISH_ID, FISH_LENGTH, FISH_WEIGHT, TRIP, TRIPCD_ID)
# 
# test_hal$out<-0
# test_hal<-test_hal[!is.na(test_hal$FISH_LENGTH),]
# test_hal<-test_hal[!is.na(test_hal$FISH_WEIGHT),]
# 
# #identify outliers (using a and b from the previous assessment log(a)=-5.021354 so a=0.00659559; b=3.124184)
# mod1<-nls(FISH_WEIGHT~a*FISH_LENGTH^b,data=test_hal,start=c(a=0.00659559,b=3.124184),na.action=na.omit) #these results are the same with a=0.001 and b=3 as was used by nell in her getLW function from the previous assessment
# test_hal$upper<-predict(mod1, list(FISH_LENGTH = test_hal$FISH_LENGTH))*1.75
# test_hal$lower<-predict(mod1, list(FISH_LENGTH = test_hal$FISH_LENGTH))*0.25
# test_hal$out[test_hal$FISH_WEIGHT<test_hal$upper&test_hal$FISH_WEIGHT>test_hal$lower]<-1
# test_lenwt.dat.all<-test_hal[,c(1:8)]
# 
# ISDB_outliers <- test_lenwt.dat.all %>% filter(out == "0") #here we lose 319 fish as outliers (not major at all in the overall dataset, it's 0.58%) 
# test_full <- test_lenwt.dat.all %>% filter(out == "1") #still 4,300+ small fish!
# 
# #bring test_full back together with the other df
# test_full <- test_full %>%
#   select("FISH_ID") %>%
#   left_join(hal_allNAFOfilter, by = "FISH_ID")
# 
# test_full %>%
#   filter(FISH_WEIGHT < 250) %>%
#   ggplot(aes(FISH_LENGTH, FISH_WEIGHT))+
#   geom_point()
# #the problem seen above where issues arose due to kg vs. g units is not seen here, these data seem cleaned
# 
# ggplot(test_full, aes(FISH_LENGTH, FISH_WEIGHT))+
#   geom_point()
# 
# # test_full %>% filter(between(FISH_LENGTH, 175, 200), between(FISH_WEIGHT, 20000, 21000)) %>%
# # ggplot(aes(FISH_LENGTH, FISH_WEIGHT, label=TRIP))+
# #   geom_point()+
# #   geom_text(aes(label=as.character(TRIP)))#outliers have been removed and data appear far more clean
```

#----Data exploration----
```{r}

ISDB_halall <- hal_allNAFOfilter %>%
  drop_na(SEXCD_ID) %>%
  drop_na(FISH_LENGTH) %>%
  drop_na(FISH_WEIGHT) %>%
  drop_na(NAFO)

MarRV <- setdata_halRV %>%
  drop_na(FSEX) %>%
  drop_na(FLEN) %>%
  drop_na(FWT) %>%
  drop_na(NAFO)
```

Adding the gear info to the ISDB tables
```{r}
gear <- ISGEARS %>%
  select(TRIP_ID, GEARCD_ID) 

ISDBhaltrips <- ISDB_halall %>%
  select(TRIP_ID, TRIPCD_ID)

hal_gear <- ISDBhaltrips %>%
  left_join(gear, by = "TRIP_ID")

hal_gear <- hal_gear %>% count(TRIP_ID, GEARCD_ID)

n_occur <- data.frame(table(hal_gear$TRIP_ID))  %>% filter(Freq > 1) %>% rename(TRIP_ID = Var1)#47 trips where 2 types of gear are 

n_occur <- n_occur %>%
  select(TRIP_ID) 

n_occur2 <- n_occur[,]

repeat_gear <- subset(hal_gear, TRIP_ID %in% n_occur2) #mostly all 12, 15 so both trawls (can make just trawl), then 1 trip with a HARPOONED halibut...is that possible?!
# ISDB_halall %>% filter(TRIP_ID == "5781")

hal_gear <- hal_gear  %>%
  mutate(GEARCD_ID = replace(GEARCD_ID, GEARCD_ID %in% c(7, 11, 12, 15, 16), "trawl")) %>%
  mutate(GEARCD_ID = replace(GEARCD_ID, GEARCD_ID %in% c(41), "gillnet")) %>%
  mutate(GEARCD_ID = replace(GEARCD_ID, GEARCD_ID %in% c(21, 22), "seine")) %>%
  mutate(GEARCD_ID = replace(GEARCD_ID, GEARCD_ID %in% c(50, 51), "longline")) %>%
  mutate(GEARCD_ID = replace(GEARCD_ID, GEARCD_ID == 71, "dredge")) %>%
  mutate(GEARCD_ID = replace(GEARCD_ID, GEARCD_ID == 81, "harpoon")) %>%
  rename(GEAR = GEARCD_ID) 


#For my purposes Im going to change the harpoon recording to longline (no way of knowing which fish(es) were harpooned)
hal_gear <- hal_gear %>%
  mutate(GEAR = replace(GEAR, GEAR == "harpoon", "longline")) %>%
  select(TRIP_ID, GEAR) %>%
  distinct()

n_occur3 <- data.frame(table(hal_gear2$TRIP_ID)) %>% filter(Freq > 1)
hal_gear %>% count(TRIP_ID)


#bringing gear into my final tables
ISDB_halall <- ISDB_halall %>%
  left_join(hal_gear2, by = "TRIP_ID")
```

Bring RV and ISDB together: making new columns and removing some columns in the rv survey data
```{r}
MarRV$REMARKS <- paste(MarRV$REMARKS.x, MarRV$REMARKS.y, sep=",")

MarRV <- MarRV %>%
  mutate(GEAR = "trawl") %>%
  mutate(TRIPCD_ID = "RV") %>%
  mutate(TYPE = "RV") %>%
  select(-"FMAT", -"AGMAT", -"AGE", -"CLEN", -"SIZE_CLASS", -"ETIME", -"START_DEPTH", -"END_DEPTH", -"SURFACE_TEMPERATURE",
         -"BOTTOM_TEMPERATURE", -"BOTTOM_SALINITY", -"STATION", -"REMARKS.x", -"REMARKS.y", -"STRAT") %>%
  rename("TRIP" = "MISSION", "SEXCD_ID" = "FSEX", "SET_NO" = "SETNO", "SPECCD_ID" = "SPEC", "FISH_NO" = "FSHNO", 
         "FISH_LENGTH" = "FLEN", "FISH_WEIGHT" = "FWT", "COMMENTS" = "REMARKS", "BOARD_DATE" = "SDATE", "LAT1" = "SLAT", 
         "LONG1" = "SLONG", "LAT2" = "ELAT", "LONG2" = "ELONG", "NAFAREA_ID" = "NAME")
```

Removing excess columns from ISDB datasets to merge with RV
```{r}
ISDBdat <- ISDB_halall %>%
  mutate(TYPE = "ISDB") %>%
  mutate(yr_bin = 
           ifelse(YEAR %in% c(1970, 1971, 1972, 1973, 1974, 1975), "1970-1975", 
           ifelse(YEAR %in% c(1976, 1977, 1978, 1979, 1980), "1976-1980",
           ifelse(YEAR %in% c(1981, 1982, 1983, 1984, 1985), "1981-1985", 
           ifelse(YEAR %in% c(1986, 1987, 1988, 1989, 1990), "1986-1990",
           ifelse(YEAR %in% c(1991, 1992, 1993, 1994, 1995), "1991-1995",
           ifelse(YEAR %in% c(1996, 1997, 1998, 1999, 2000), "1996-2000",
           ifelse(YEAR %in% c(2001, 2002, 2003, 2004, 2005), "2001-2005",
           ifelse(YEAR %in% c(2006, 2007, 2008, 2009, 2010), "2006-2010",
           ifelse(YEAR %in% c(2011, 2012, 2013, 2014, 2015), "2011-2015",
           ifelse(YEAR %in% c(2016, 2017, 2018, 2019, 2020), "2016-2020", "Error")))))))))))

ISDB_halall <- ISDBdat %>%
  select(-"FISH_ID", -"TRIP_ID", -"VESS_ID", -"LICENSE_NO", -"LANDING_DATE", -"FISHSET_ID", -"SETCD_ID", -"SPECSCD_ID.x",
         -"CATCH_ID", -"MATCD_ID", -"LAT3", -"LONG3", -"LAT4", -"LONG4")
```

Merging the ISDB datasets with the RV dataset
```{r}
hal_datAll <- rbind(ISDB_halall, MarRV)
```

Identifying and removing the outliers from the overall dataset
```{r}
library(sqldf)

hal_datAll <- hal_datAll %>%
  mutate(id = row_number())

test_halAll <- hal_datAll %>%
  select(id, FISH_LENGTH, FISH_WEIGHT, TRIP, TRIPCD_ID)

test_halAll$out<-0
test_halAll<-test_halAll[!is.na(test_hal$FISH_LENGTH),]
test_halAll<-test_halAll[!is.na(test_hal$FISH_WEIGHT),]

#identify outliers (using a and b from the previous assessment log(a)=-5.021354 so a=0.00659559; b=3.124184)
mod_outliers<-nls(FISH_WEIGHT~a*FISH_LENGTH^b,data=test_hal,start=c(a=0.00659559,b=3.124184),na.action=na.omit) #these results are the same with a=0.001 and b=3 as was used by nell in her getLW function from the previous assessment
test_halAll$upper<-predict(mod1, list(FISH_LENGTH = test_halAll$FISH_LENGTH))*1.75
test_halAll$lower<-predict(mod1, list(FISH_LENGTH = test_halAll$FISH_LENGTH))*0.25
test_halAll$out[test_halAll$FISH_WEIGHT<test_halAll$upper&test_halAll$FISH_WEIGHT>test_halAll$lower]<-1
test_lenwt.dat.all<-test_halAll[,c(1:8)]

all_outliers <- test_lenwt.dat.all %>% filter(out == "0") #here we lose 326 fish as outliers (the overall dataset, it's 0.56%) 
test_full <- test_lenwt.dat.all %>% filter(out == "1") 

#bring test_full back together with the other df
test_full <- test_full %>%
  select("id") %>%
  left_join(hal_datAll, by = "id")

test_full %>%
  filter(FISH_WEIGHT < 250) %>%
  ggplot(aes(FISH_LENGTH, FISH_WEIGHT))+
  geom_point()
#the problem seen above where issues arose due to kg vs. g units is not seen here, these data seem cleaned

ggplot(test_full, aes(FISH_LENGTH, FISH_WEIGHT))+
  geom_point()

hal_datOR <- test_full

# test_full %>% filter(between(FISH_LENGTH, 175, 200), between(FISH_WEIGHT, 20000, 21000)) %>%
# ggplot(aes(FISH_LENGTH, FISH_WEIGHT, label=TRIP))+
#   geom_point()+
#   geom_text(aes(label=as.character(TRIP)))#outliers have been removed and data appear far more clean
```

Plot data by year/year bin
```{r}
ggplot(hal_datOR) +
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT, col = TYPE), alpha = 0.5)+
  facet_wrap(~yr_bin)

data_byyear <- hal_datOR %>% count(YEAR, TYPE)

ggplot(hal_datOR) +
  geom_bar(aes(YEAR, stat = "count"))+
  facet_grid(TYPE ~ ., scales = "free")

ggplot(hal_datOR) +
  geom_histogram(aes(FISH_LENGTH, state = "count"), alpha = 0.5) +
  facet_wrap(~YEAR)

```

Looking at the data by gear/NAFO
```{r}
ggplot(hal_datOR) +
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT, col = GEAR), alpha = 0.5)

ggplot(hal_datOR) +
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT)) +
  facet_wrap(~GEAR) #VERY few dredge (n=10), gillnet (n=2), and seine (n=3) caught fish

ggplot(hal_datOR, aes(FISH_LENGTH, fill = GEAR, col = GEAR)) +                       
  geom_histogram(position = "identity", alpha = 0.2, bins = 50) #overall trawl catches smaller fish

ggplot(hal_datOR, aes(FISH_LENGTH, fill = GEAR, col = GEAR)) +                       
  geom_histogram(position = "identity", alpha = 0.2, bins = 50) +
  facet_wrap(~yr_bin, scales = "free") ##trawl consistently caught smaller fish, even when there was significantly more trawling than longlining, but WAY more fish overall caught on longline (when scales = "free" is removed from the facet you see this)
#no real difference in the size of fish caught?


ggplot(hal_datOR, aes(FISH_LENGTH, stat = "count", fill = GEAR, col = GEAR)) +
  geom_histogram(position = "identity", alpha = 0.2) +
  facet_grid(NAFO~yr_bin) +
  theme_test() #more recent fishing in 3N, the "trawl" stuff from 1980-1990s in 4 are from silver hake fishery
```
Looking for month/seasonal 
```{r}
hal_datOR <- hal_datOR %>%
  mutate(MONTH = substr(BOARD_DATE, 6,7))

#an overall look at how many data we have for each month of the year
ggplot(hal_datOR) +
  geom_histogram(aes(FISH_LENGTH, stat = "count")) +
  facet_wrap(~MONTH)

#creating seasons
hal_datOR <- hal_datOR %>%
    mutate(QUARTER = 
           ifelse(MONTH %in% c("01","02","03"), "1", 
           ifelse(MONTH %in% c("04","05","06"), "2",
           ifelse(MONTH %in% c("07","08","09"), "3", 
           ifelse(MONTH %in% c("10","11","12"), "4", "Error")))))

hal_datOR <- hal_datOR %>%
  mutate(NAFO = replace(NAFO, NAFO %in% c("5Y", "5Z", "4X"), "4X+5"))

#histogram of data by season  
ggplot(hal_datOR, aes(FISH_LENGTH, stat = "count", fill = GEAR, col = GEAR)) +
  geom_histogram(position = "identity", alpha = 0.2) +
  facet_grid(~QUARTER) +
  theme_test()
#histogram of season by NAFO
ggplot(hal_datOR, aes(FISH_LENGTH, stat = "count", fill = GEAR, col = GEAR)) +
  geom_histogram(position = "identity", alpha = 0.2) +
  facet_grid(NAFO~QUARTER) +
  theme_test()
#histogram of season by year bin 

tiff(file="C:/Users/harperd/Documents/Halibut/GitDataInputs/DataInputs/figures/hal_gear_quarter_year.tiff",
     width=10, height=10, units="in", res=500)
ggplot(hal_datOR, aes(FISH_LENGTH, stat = "count", fill = GEAR, col = GEAR)) +
  geom_histogram(position = "identity", alpha = 0.2) +
  facet_grid(yr_bin~QUARTER) +
  theme_test()
dev.off()

```


```{r}
library(lme4)

overall.mod <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + (1|YEAR), hal_datOR)

summary(overall.mod)
library(sjp.lmer)
plot_model(overall.mod, type = "re")
plot(overall.mod)

df <- data.frame(YEAR=row.names(coef(overall.mod)[[1]]), coef(overall.mod)[[1]])

hal_datOR2 <- hal_datOR %>% drop_na("FISH_WEIGHT")

hal_datOR2$fit <- predict(overall.mod) 
##this just plots the predicts weight values from the "overall model" (including all data, not separated by sex)...all follow the same curve b/c they are predictions from the same model. Now to model them separately?
ggplot(hal_datOR2,aes(FISH_LENGTH, FISH_WEIGHT, col=yr_bin)) +  
      geom_line(aes(y=exp(fit)), size=1) +
      geom_hline(yintercept=0, linetype="dashed") +
      facet_wrap(~yr_bin)+
      theme_bw()
```
```{r}
hal_datOR <- hal_datOR %>%
  mutate(logL = log(FISH_LENGTH), logW = log(FISH_WEIGHT))

mod2 <- lm(logW ~ logL, hal_datOR)
summary(mod2)

ggplot(hal_datOR, aes(x = logL, y = logW)) +
  geom_point() +
  geom_smooth(method = "lm")

plot(mod2, which = 1)

boxplot(logW ~ NAFO, data = hal_datOR) #doesn't look like overall size by area matters...but the relationship could be different by area yet

ggplot(hal_datOR, aes(x = logL, y = logW, colour = NAFO)) +
  geom_point(size = 2, alpha = 0.2) +
  theme_classic() +
  theme(legend.position = "none") #could be some difference in where fish at length/weight extremes are caught, but that could also be a matter of the gear (only longline in 3, lots of trawling in 4...)

ggplot(aes(logL, logW, col = GEAR), data = hal_datOR) + 
  geom_point(alpha = 0.2) + 
  facet_wrap(~ NAFO)

mod3 <- lm(logW ~ logL + NAFO, hal_datOR)
summary(mod3)

#Variable selection: I'm going to say that we could have fish length, quarter, GEAR and NAFO (and maybe even year bin?) as fixed effects; and then we have YEAR as a random effect (when we want to know if something is affecting the response variable and by how much then that would be a fixed effect, if we just expect that something would have an effect on the response variable and we don't care by how much but we want to control by it then that would be a random effect). Basically we need to figure out what we are trying to make predictions about (fixed effects) and what's just "noise" (random effects) that need to be controlled for.
mod3 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + (1|YEAR), hal_datOR)
summary(mod3)
#here we see that YEAR only accounts for 5.65% of the overall variation (divide the variance from YEAR by the overall variance (YEAR+Residual)) so the difference between years explains 5% of the "left over" variance after the variance explained by fixed effects (just fish length here)

#The model above only allows for variation in the intercept, I think we would want to model the variation in the slope as well. So below is a random-slope and random-intercept model...doesn't converge
mod4 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + (1 + (log(FISH_LENGTH))|YEAR), hal_datOR)

summary(mod4)

library(lmerTest)
mod5 <- lmer("log(FISH_WEIGHT) ~ (log(FISH_LENGTH)) + NAFO + QUARTER + (1|YEAR)", hal_datOR)
print(anova(mod5))
summary(mod5) #p-val for intercept(first level, so in this cas NAFO3N) tells you whether the intercept is different from zero, and then all the other p-vals tell you if that level is different from the intercept
```

looking into the unknowns
```{r}
hal_unknowns <- hal_datOR %>%
  filter(SEXCD_ID == "0") %>%
  drop_na(SEXCD_ID)

hal_datsex <- hal_datOR %>%
  drop_na(SEXCD_ID)

ggplot(hal_unknowns) +
  geom_point(aes(FISH_LENGTH, FISH_WEIGHT, col = TYPE))

ggplot(hal_unknowns, aes(FISH_LENGTH, stat = "count", col = TYPE, fill = TYPE)) +
  geom_histogram(position = "identity", alpha = 0.2) 

ggplot(hal_datsex, aes(FISH_LENGTH, stat = "count", col = TYPE, fill = TYPE)) +
  geom_histogram(position = "identity", alpha = 0.2) +
  facet_grid(SEXCD_ID~.)

ggplot(hal_datsex, aes(FISH_LENGTH, FISH_WEIGHT, col = TYPE)) +
  geom_point() +
  facet_grid(SEXCD_ID~.)

```
#----MODEL BUILDING (first attempt)----
```{r}
hal_male <- hal_datOR %>%
  filter(SEXCD_ID == "1")
hal_female <- hal_datOR %>%
  filter(SEXCD_ID == "2")
hal_unknowns <- hal_datOR %>%
  filter(SEXCD_ID == "0")
```

Starting with the overall model selection
Here I will start with the most basic model, with a random effect of YEAR (where the intercepts will vary by the random effect for the different levels, but the slope will be fixed (since I can't get the model to converge with the random slopes...get help with that))

I chose year as the random effect as I expect to see variation due to it, but want to control for that. I have fish length, quarter, and NAFO as fixed effects since I expect them to have an affect and we want to know how much (make predictions about them)
```{r}
library(lmerTest)
hal_datOR3 <- hal_datOR %>%
  drop_na(NAFO) %>%
  drop_na(SEXCD_ID)

hal_datOR %>% count(FISH_LENGTH)


mod1OA <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + (1|YEAR), hal_datOR3)

#mod1RIRS <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + (1 + log(FISH_LENGTH)|YEAR))  #I think this is how you would write it for random intercept and random slope for the different levels of the random effect?

mod2OA <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + NAFO + SEXCD_ID + (1|YEAR), hal_datOR3)
summary(mod2OA)

mod3OA <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + NAFO + (1|YEAR), hal_datOR3) #results of anova basically say NAFO does nothing?

mod4OA <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + NAFO + (1|YEAR), hal_datOR3)

mod5OA <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + (1 + QUARTER|YEAR), hal_datOR3) #model with random intercepts and slopes, is it right to think that this means that there would be differences in slopes by quarter for the different years?

anova(mod1OA, mod2OA, mod3OA, mod4OA, mod5OA)

cc <- scales::seq_gradient_pal("yellow", "blue", "Lab")(seq(0,1,length.out=51))
ggplot(hal_datOR3, aes(x = FISH_LENGTH, y = FISH_WEIGHT, colour = YEAR)) +
  scale_colour_manual(values = cc) +
      facet_wrap(~QUARTER) +   
      theme_classic() +
      geom_line(data = cbind(hal_datOR3, pred = exp(predict(mod5OA))), aes(y = pred), size = 1) +  # adding predicted line from mixed model 
      theme(legend.position = "none",
            panel.spacing = unit(2, "lines"))
```

Models for males
```{r}
hal_male <- hal_male %>%
  drop_na(NAFO) %>%
  drop_na(FISH_LENGTH) %>%
  drop_na(FISH_WEIGHT)


mod1m <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + (1|YEAR), hal_male)
summary(mod1m) #YEAR accounts for ~7% of the variability leftover after considering the fixed effect (length)
#mod1RIRS <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + (1 + log(FISH_LENGTH)|YEAR))  #I think this is how you would write it for random intercept and random slope for the different levels of the random effect?

mod1.1m <- lm(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + as.factor(yr_bin), hal_male)
summary(mod1.1m)


mod2m <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + (1|YEAR), hal_male)
summary(mod2m)

mod3m <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + NAFO + (1|YEAR), hal_male) #results of anova basically say NAFO does nothing?
summary(mod3m)

mod4m <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + NAFO + (1|YEAR), hal_male)

mod5m <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + (1 + QUARTER|YEAR), hal_male) #model with random intercepts and slopes, is it right to think that this means that there would be differences in slopes by quarter for the different years?
#mod6m <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + (1 + log(FISH_LENGTH)|YEAR), hal_male) #fails to converge


anova(mod1m, mod2m, mod3m, mod4m, mod5m)

cc <- scales::seq_gradient_pal("yellow", "blue", "Lab")(seq(0,1,length.out=51))
ggplot(hal_male, aes(x = FISH_LENGTH, y = FISH_WEIGHT, colour = YEAR)) +
  scale_colour_manual(values=cc)+
      facet_wrap(~QUARTER) + 
      theme_classic() +
      geom_line(data = cbind(hal_male, pred = exp(predict(mod2m))), aes(y = pred), size = 1) +
      theme(legend.position = "none",
            panel.spacing = unit(2, "lines"))

cc <- scales::seq_gradient_pal("yellow", "blue", "Lab")(seq(0,1,length.out=4))
ggplot(hal_male, aes(x = FISH_LENGTH, y = FISH_WEIGHT, colour = QUARTER)) +
  scale_colour_manual(values=cc)+
      theme_classic() +
      geom_line(data = cbind(hal_male, pred = exp(predict(mod2m))), aes(y = pred), size = 1) + 
      theme(legend.position = "none",
            panel.spacing = unit(2, "lines"))

cc <- scales::seq_gradient_pal("yellow", "blue", "Lab")(seq(0,1,length.out=51))
ggplot(hal_male, aes(x = FISH_LENGTH, y = FISH_WEIGHT, colour = YEAR)) +
  scale_colour_manual(values=cc)+
      facet_wrap(~QUARTER) + 
      theme_classic() +
      geom_line(data = cbind(hal_male, pred = exp(predict(mod1m))), aes(y = pred), size = 1) +  # adding predicted line from mixed model mod1m
      theme(legend.position = "none",
            panel.spacing = unit(2, "lines")) ##so the slopes vary on this, even though it's supposed to just be a varying intercept model? Is that because the predicted values are expotentiated due to the logged variables for the model?
```

female models
```{r}
hal_female <- hal_female %>%
  drop_na(NAFO) %>%
  drop_na(FISH_LENGTH) %>%
  drop_na(FISH_WEIGHT)


mod1f <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + (1|YEAR), hal_female)
#mod1RIRS <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + (1 + log(FISH_LENGTH)|YEAR))  #I think this is how you would write it for random intercept and random slope for the different levels of the random effect?

mod2f <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + (1|YEAR) + (1|TRIPCD_ID), hal_female)
summary (mod2f)

mod3f <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + NAFO + (1|YEAR), hal_female) #results of anova basically say NAFO does nothing?

mod4f <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + NAFO + (1|YEAR), hal_female)

mod5f <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + (1 + QUARTER|YEAR), hal_female) #model with random intercepts and slopes, is it right to think that this means that there would be differences in slopes by quarter for the different years?
#mod6f <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + (1 + log(FISH_LENGTH)|YEAR), hal_female) #this fails to converge

mod7f <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + (1 + log(FISH_LENGTH)|YEAR), hal_female) #this converges...

anova(mod1f, mod2f, mod3f, mod4f, mod5f, mod7f)
```


Plots for presentation
```{r}
hal_datOR <- hal_datOR %>%
  drop_na(NAFO)

tiff(file="C:/Users/harperd/Documents/Halibut/GitDataInputs/DataInputs/figures/length_gear_quarter_year.tiff",
     width=10, height=10, units="in", res=500)
ggplot(hal_datOR, aes(FISH_LENGTH, stat = "count", fill = GEAR, col = GEAR)) +
  geom_histogram(position = "identity", alpha = 0.2) +
  facet_grid(yr_bin~QUARTER) +
  theme_test()
dev.off()

tiff(file="C:/Users/harperd/Documents/Halibut/GitDataInputs/DataInputs/figures/length_trip_NAFO_quarter.tiff",
     width=10, height=10, units="in", res=500)
ggplot(hal_datOR, aes(FISH_LENGTH, count = "stat"))+
  geom_histogram(aes(col = TRIPCD_ID, fill = TRIPCD_ID)) +
  facet_wrap(~NAFO)
dev.off()


tiff(file="C:/Users/harperd/Documents/Halibut/GitDataInputs/DataInputs/figures/bar_sex_LW.tiff",
     width=10, height=10, units="in", res=500)
ggplot(hal_datsex, aes(FISH_LENGTH, stat = "count", col = TYPE, fill = TYPE)) +
  geom_histogram(position = "identity", alpha = 0.2) +
  facet_grid(SEXCD_ID~.)
dev.off()

tiff(file="C:/Users/harperd/Documents/Halibut/GitDataInputs/DataInputs/figures/point_sex_LW.tiff",
     width=10, height=10, units="in", res=500)
ggplot(hal_datsex, aes(FISH_LENGTH, FISH_WEIGHT, col = TYPE)) +
  geom_point() +
  facet_grid(SEXCD_ID~.)
dev.off()
```

models for presentation
```{r}
ggplot(hal_datsex, aes(FISH_LENGTH, FISH_WEIGHT, col = TYPE)) +
  geom_point(alpha = 0.2) +
  facet_grid(SEXCD_ID~QUARTER)
```

#----Making changes from last meeting----

Starting with reducing the number of trip types so that any type with less than 30 observations are lumped into other
```{r}
hal_datOR<- hal_datOR %>%
  drop_na(SEXCD_ID) %>%
  drop_na(NAFO) %>%
  drop_na(FISH_LENGTH) %>%
  drop_na(FISH_WEIGHT)

hal_datOR <- hal_datOR %>%
  mutate(TRIPCD_ID = replace(TRIPCD_ID, TRIPCD_ID %in% c("8", "70", "230", "4320", "7054", "7055","7060", "7061"), "7099"))

hal_datORtrip$TRIPCD_ID <- as.integer(hal_datOR$TRIPCD_ID)

hal_datORtrip %>% count(TRIPCD_ID)

#NA here are the RV trips
trips_halcaught2 <- hal_datORtrip %>%
  left_join(ISTRIPTYPECODES, by = "TRIPCD_ID") %>%
  select("TRIPCD_ID", "TRIP_TYPE") %>%
  count(TRIPCD_ID, TRIP_TYPE)
```

Reducing NAFO to 3 and 4/5
```{r}
hal_datOR <- hal_datOR %>%
  mutate(NAFO_ZONE = substr(NAFO,1,1)) %>%
  mutate(NAFO_ZONE = replace(NAFO_ZONE, NAFO_ZONE == 4, "4+5"))
```

Starting to look at one overall model
```{r}
#this is the overall model I think we want to look at. To look at the fixed effects of quarter, sex, nafo, and the random effects of year and trip type

hal_datOR$SEXCD_ID <- as.character(hal_datOR$SEXCD_ID)

mod_all1 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + SEXCD_ID + NAFO_ZONE + (1|YEAR) + (1|TRIPCD_ID), hal_datOR)
summary(mod_all1)


mod_all2 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + as.factor(SEXCD_ID) + (1|YEAR) + (1|TRIPCD_ID), hal_datOR)
summary(mod_all2)

mod_all3 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + (1|YEAR) + (1|TRIPCD_ID), hal_datOR)
summary(mod_all3)

mod_all4 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + NAFO_ZONE + (1|YEAR) + (1|TRIPCD_ID), hal_datOR)
summary(mod_all4)

```

Checking the predicted values for the different sexes (male = 1, female = 2, unknown = 0)
```{r}
mod_all1 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + SEXCD_ID + NAFO_ZONE + (1|YEAR) + (1|TRIPCD_ID), hal_datOR)

sextest <- ggpredict(mod_all1, terms = c("FISH_LENGTH", "SEXCD_ID"), condition = c(QUARTER = 2, NAFO_ZONE = 3), type = "re") #since QUARTER and NAFO_ZONE are categorical I don't actually need to put these conditions in here because ggpredict() picks a reference level of each categorical predictor anyways

ggplot(sextest, aes(x = x, y = predicted, colour = group)) +
  geom_line() +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), linetype=0, alpha = .15)+
  labs(
    colour = get_legend_title(sextest),
    x = get_x_title(sextest),
    y = get_y_title(sextest),
    title = get_title(sextest)
  )


plot(sextest)
```

```{r}
Qtest <- ggpredict(mod_all1, terms = c("FISH_LENGTH", "QUARTER"), condition = c(NAFO = 3, SEXCD_ID = c(0,1,2)), type = "re")

ggplot(Qtest, aes(x = x, y = predicted, colour = group)) +
  geom_line() +
  labs(
    colour = get_legend_title(Qtest),
    x = get_x_title(Qtest),
    y = get_y_title(Qtest),
    title = get_title(Qtest)
  )

plot(Qtest)
```

```{r}
NAFOtest <- ggpredict(mod_all1, terms = c("FISH_LENGTH", "NAFO_ZONE"), condition = c(QUARTER = 2, SEXCD_ID = c(0,1,2)), type = "re")

ggplot(NAFOtest, aes(x = x, y = predicted, colour = group)) +
  geom_line() +
  facet_wrap(~group)+
  labs(
    colour = get_legend_title(NAFOtest),
    x = get_x_title(NAFOtest),
    y = get_y_title(NAFOtest),
    title = get_title(NAFOtest)
  )

plot(NAFOtest)
```

Trying ggemmeans() instead of ggpredict()...results look basically the same...
```{r}
library(emmeans)

sextestmeans <- ggemmeans(mod_all1, terms = c("FISH_LENGTH", "SEXCD_ID"), condition = c(QUARTER = 2, NAFO_ZONE = 3), type = "re") #since QUARTER and NAFO_ZONE are categorical I don't actually need to put these conditions in here because ggpredict() picks a reference level of each categorical predictor anyways

ggplot(sextestmeans, aes(x = x, y = predicted, colour = group)) +
  geom_line() +
  labs(
    colour = get_legend_title(sextestmeans),
    x = get_x_title(sextestmeans),
    y = get_y_title(sextestmeans),
    title = get_title(sextestmeans)
  )

plot(sextestmeans)
```

model with unknowns removed! Here with unknowns removed you still see that males and females are basically the same...
```{r}
unrm_haldat <- hal_datOR %>%
  filter(SEXCD_ID != "0")

mod_sex_unrm <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + SEXCD_ID + NAFO_ZONE + (1|YEAR) + (1|TRIPCD_ID), unrm_haldat)

sextest2 <- ggpredict(mod_sex_unrm, terms = c("FISH_LENGTH", "SEXCD_ID"), condition = c(QUARTER = 2, NAFO_ZONE = 3), type = "re") #since QUARTER and NAFO_ZONE are categorical I don't actually need to put these conditions in here because ggpredict() picks a reference level of each categorical predictor anyways

ggplot(sextest2, aes(x = x, y = predicted, colour = group)) +
  geom_line() +
  geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), linetype=0, alpha = .15)+
  labs(
    colour = get_legend_title(sextest2),
    x = get_x_title(sextest2),
    y = get_y_title(sextest2),
    title = get_title(sextest2)
  )


plot(sextest2)

```

model selection
```{r}
#overall (FE: length, sex, quarter, nafo; RE: trip, year)
m1 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + SEXCD_ID + NAFO_ZONE + (1|YEAR) + (1|TRIPCD_ID), hal_datOR)
summary(m1)
#(FE:length; RE: trip, year)
m2 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + (1|YEAR) + (1|TRIPCD_ID), hal_datOR)
#(FE: length, sex; RE: trip, year)
m3 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + SEXCD_ID + (1|YEAR) + (1|TRIPCD_ID), hal_datOR)
#(FE: length, quarter; RE: trip, year)
m4 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + (1|YEAR) + (1|TRIPCD_ID), hal_datOR)
#(FE: length, nafo; RE: trip, year)
m5 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + NAFO_ZONE + (1|YEAR) + (1|TRIPCD_ID), hal_datOR)
#(FE: length, sex, quarter; RE: trip, year)
m6 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + SEXCD_ID + QUARTER + (1|YEAR) + (1|TRIPCD_ID), hal_datOR)
#(FE: length, sex, nafo; RE: trip, year)
m7 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + SEXCD_ID + NAFO_ZONE + (1|YEAR) + (1|TRIPCD_ID), hal_datOR)
#(FE: length, quarter, nafo; RE: trip, year)
m8 <- lmer(log(FISH_WEIGHT) ~ log(FISH_LENGTH) + QUARTER + NAFO_ZONE + (1|YEAR) + (1|TRIPCD_ID), hal_datOR)

anova(m1, m2, m3, m4, m5, m6, m7, m8) #m2 and m5 are lowest AIC (basically the same, NAFO has almost no effect on the model)
```
