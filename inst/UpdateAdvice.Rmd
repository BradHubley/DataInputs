---
title: "Update Advice"
author: "Brad"
date: "2022-10-13"
output: html_document
---


```{r setup, include=FALSE}
library(ROracle)
library(devtools)
library(tidyverse)
source(file.path(getwd(), "directories.r"))
source(file.path(wd, "passwords.r")) 

ds_all <- Mar.datawrangling::load_datasources()

devtools::load_all(".")

bins=seq(0,260,5)
# labelled by upper bound


Current.Year <- 2022


```


## Update data from database 

```{r }


# Update data from database 

# Mar.datawrangling::get_data(db='isdb',data.dir=datadir,fn.oracle.username = uid, fn.oracle.password = pwd, fn.oracle.dsn = 'ptran',usepkg='roracle',force.extract=T)
# open and check setprofile_wide to confirm that you have year, latitude & longitude

# RVdata<-get4VWXRV(uid, pwd, use.local=F,datadir=datadir)

```



#NS RV survey

```{r}

#RVdata<-get4VWXRV(uid, pwd, use.local=F,datadir=datadir)
RVdata<-get4VWXRV(uid, pwd, use.local=T,datadir=datadir)
RVinputs<-prepRVdata(RVdata,bins=bins,years=1970:2022, raw=T)
NSRV_Index<-RVinputs$Index

# 
NSRV_Index$NPT[NSRV_Index$year==2021]<-NA

```

#Halibut Longline Survey

```{r}

  HSFixed_Index<-FixedSurveyIndex(datadir=datadir,yrs=1998:2022)
  HSRandom_Index<-StratifiedRandomSurveyIndex(datadir=datadir,yrs=2017:Current.Year,use.calc.weight = F)

```

# Harvest Control Rule
```{r}
value <- HSRandom_Index$mean3_biomass[HSRandom_Index$Year==Current.Year]
HCR(value)
#HCR(value, q=0.0019) # when using calculated weight

```


## plot survey indices SSR version
```{r}
#RVinputs$Index
png(file.path(wd,'figures',"ModelindicesSSR2.png"), width =8, height = 6,units='in',pointsize=12, res=300,type='cairo')
par(mfcol=c(2,1), mar = c(0,4,0,0.5), omi = c(0.5, 0.25, 0.5, 0.25),las=1)

plot(NPT~year,NSRV_Index, ylab="Number / tow", xlab = '', ylim=c(0,max(NPT,na.rm=T)*1.2), type='o',pch=16,xlim=c(1970,Current.Year),xaxt='n')
axis(1,lab=F)
points(2018,NSRV_Index$NPT[NSRV_Index$year==2018],col='red',cex=2)
points(2022,NSRV_Index$NPT[NSRV_Index$year==2022],col='red',cex=2)

plot(KgPKH~Year,HSFixed_Index,type='l',pch=16,col='grey',lty=2,ylim=c(0,255),xlim=c(1970,Current.Year), ylab="Kg / 1000 hooks")
lines(mean3_biomass~Year,HSFixed_Index)
lines(KgPKH~Year,HSRandom_Index,type='o',pch=16,col='blue')
#lines(KgPKH+KgPKHse~Year,HSRandom_Index,lty=2,col='blue')
#lines(KgPKH-KgPKHse~Year,HSRandom_Index,lty=2,col='blue')
lines(mean3_biomass~Year,HSRandom_Index,lwd=3)

dev.off()


```

# Comparing calculated weight vs estimated weight
```{r}
 HSRandom_Index<-StratifiedRandomSurveyIndex(datadir=datadir,yrs=2017:Current.Year,use.calc.weight = F)
 HSRandom_Index2<-StratifiedRandomSurveyIndex(datadir=datadir,yrs=2017:Current.Year,use.calc.weight = T)

```

```{r}
 plot(KgPKH~Year,HSRandom_Index,ylim=c(0,150),type='l',lwd=2)
 with(HSRandom_Index,lines(Year,mean3_biomass,lty=2))
 with(HSRandom_Index2,lines(Year,KgPKH,lwd=2,col=2))
 with(HSRandom_Index2,lines(Year,mean3_biomass,lty=2,col=2))
 
 plot(KgPKH/0.002~Year,HSRandom_Index,ylim=c(0,60000),type='l',lwd=2,ylab="Biomass")
 with(HSRandom_Index,lines(Year,mean3_biomass/0.002,lty=2))
 with(HSRandom_Index2,lines(Year,KgPKH/0.0019,lwd=2,col=2))
 with(HSRandom_Index2,lines(Year,mean3_biomass/0.0019,lty=2,col=2))
 
 
 
```

