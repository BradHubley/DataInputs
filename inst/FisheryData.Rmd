---
title: "FisheryData"
author: "Brad"
date: "March 1, 2021"
output: html_document
---

```{r setup, include=FALSE}
library(devtools)
#install_github("Maritimes/Mar.datawrangling")
#install_github("Maritimes/Mar.bycatch")
 library(Mar.datawrangling)
 library(Mar.bycatch)
 library(tidyverse)
library(CircStats)
library(lubridate)
#install_github("BradHubley/SpatialHub")
library(SpatialHub)


source(file.path(getwd(), "directories.r"))
#datadir="C:/Users/hubleyb/Documents/Halibut/data"
#wd="C:/Users/hubleyb/Documents/Halibut/Git/DataInputs/"
#datadir="C:/Users/harperd/Documents/Halibut/RDataVault"
#wd="C:/Users/harperd/Documents/Halibut/GitDataInputs/DataInputs/"
source(file.path(wd, "passwords.r"))

```

## Update data from database 
## Marfis from data,wrangling
```{r }

get_data(db='marfis',data.dir=datadir,fn.oracle.username = uid, fn.oracle.password = pwd, fn.oracle.dsn = 'ptran',usepkg='roracle',force.extract=T)


```

## from Mar.bycatch
```{r}
yrs = 2002:2020
fleets <- list()
        for (i in 1:length(yrs)){
          cat(yrs[i])
          thisyear = fleet_halibut(useLocal=F, data.dir=datadir, dateStart=paste0(yrs[i],'-01-01'), dateEnd=paste0(yrs[i],'-12-31'), keepSurveyTrips=T, oracle.username=uid, oracle.password=pwd, oracle.dsn='ptran',usepkg="roracle")
          fleets[[i]]<-thisyear$marf$MARF_SETS
          rm(thisyear)
        }
fleets[[1]]$CALC_AREA<-NA
marf<-do.call("rbind",fleets)


```

##
```{r }
catch.data <- na.omit(with(subset(marf,year(DATE_FISHED)==2020),data.frame(LOG_EFRT_STD_INFO_ID,LONGITUDE,LATITUDE,RND_WEIGHT_KGS)))
catch.data$LOG_EFRT_STD_INFO_ID <- 1:nrow(catch.data)
summary(catch.data)

```

# plot annual
```{r}

lvls=seq(0,7000,1000)
xl=c(-69,-47)
yl=c(40,48)


catch.grids <- SpatialHub::gridData(catch.data,FUN=sum,lvls=lvls,grid.size=20)
SpatialHub::bioMap(xlim = xl, ylim = yl, mapRes="MR", poly.lst=catch.grids)
SpatialHub::contLegend('bottomright', lvls=lvls/1000, Cont.data=catch.grids, title="MT",cex=.7)

```

### Loop for annual

```{r}

lvls=seq(0,7000,1000)
xl=c(-69,-47)
yl=c(40,48)

for(y in yrs){
  catch.data <- na.omit(with(subset(marf,year(DATE_FISHED)==y),data.frame(LOG_EFRT_STD_INFO_ID,LONGITUDE,LATITUDE,RND_WEIGHT_KGS)))
  catch.data$LOG_EFRT_STD_INFO_ID <- 1:nrow(catch.data)
  #summary(catch.data)
  catch.grids <- SpatialHub::gridData(catch.data,FUN=sum,lvls=lvls,grid.size=20)
  
  pdf(file.path(wd,'figures',paste0('marfisCatch',y,'.pdf')),width=10,height=7)
  
  SpatialHub::bioMap(xlim = xl, ylim = yl, mapRes="MR", poly.lst=catch.grids)
  SpatialHub::contLegend('bottomright', lvls=lvls/1000, Cont.data=catch.grids, title="MT",cex=0.8)
  dev.off()

}



```


### Loop for quarterly year blocks

```{r}
q=1:4
yrblocks <- list(2001:2005,2006:2010,2011:2015,2016:2020)
  
for(i in q){
  for(j in 1:length(yrblocks)){
    catch.data <- na.omit(with(subset(marf,quarter(DATE_FISHED)==i&year(DATE_FISHED)%in%yrblocks[[j]]),data.frame(LOG_EFRT_STD_INFO_ID,LONGITUDE,LATITUDE,RND_WEIGHT_KGS)))
    catch.data$LOG_EFRT_STD_INFO_ID <- 1:nrow(catch.data)
    catch.grids <- SpatialHub::gridData(catch.data,FUN=sum,lvls=lvls,grid.size=20)
    #print(summary(catch.grids))
    
    #pdf(file.path(wd,'figures',paste0('marfisCatch','Q',i,min(yrblocks[[j]]),'-',max(yrblocks[[j]]),'.pdf')),width=10,height=7)
    png(file.path(wd,'figures',paste0('marfisCatch','Q',i,min(yrblocks[[j]]),'-',max(yrblocks[[j]]),'.png')),width=9,height=5,units='in',pointsize=12, res=300,type='cairo')
    
    SpatialHub::bioMap(xlim = xl, ylim = yl, mapRes="MR", poly.lst=catch.grids,title = paste('Q',i,min(yrblocks[[j]]),'-',max(yrblocks[[j]])))
    SpatialHub::contLegend('bottomright', lvls=lvls/1000, Cont.data=catch.grids, title="MT",cex=0.8)
    dev.off()
  }
}


	



```


### Loop for monthly

```{r}
	require(animation)# for creating gif

	### GIF animations ###
	## set some options first
	oopt = ani.options(interval = 0.4, nmax = length(yrs)* 12, outdir=file.path(wd,'figures'))
	saveGIF({
for(y in yrs){
  fleet <- get(paste0('fleet',y))
  for(i in 1:12){
    catch.data <- na.omit(with(subset(fleet,month(DATE_FISHED)==i),data.frame(LOG_EFRT_STD_INFO_ID,LONGITUDE,LATITUDE,RND_WEIGHT_KGS)))
    catch.data$LOG_EFRT_STD_INFO_ID <- 1:nrow(catch.data)
    catch.grids <- SpatialHub::gridData(catch.data,FUN=sum,lvls=lvls,grid.size=20)
    #print(summary(catch.grids))
    
    #pdf(file.path(wd,'figures',paste0('marfisCatch',y,i,'.pdf')),width=10,height=7)
    
    SpatialHub::bioMap(xlim = xl, ylim = yl, mapRes="MR", poly.lst=catch.grids,title = paste(month(i,label=T),y))
    SpatialHub::contLegend('bottomright', lvls=lvls/1000, Cont.data=catch.grids, title="MT",cex=0.8)
    #dev.off()
    
  }

	  ani.pause() ## pause for a while (’interval’)
	}
	}, interval = 0.1, movie.name = "marfis.gif", ani.width = 900, ani.height = 600)



```


```{r}
marf$YEAR<-year(marf$DATE_FISHED)
marf$NAFO <-substr(marf$NAFO_AREA,1,2)
marf.tab<-marf %>% group_by(YEAR,NAFO) %>% summarise(catch=round(sum(RND_WEIGHT_KGS/1000,na.rm=T),2))%>% pivot_wider(.,names_from = NAFO,values_from = catch)
marf.tab
write.csv(marf.tab,"MarfisHalibutLandings_t.csv",row.names=F)
```

```{r}
 SpatialHub::bioMap("WSS", mapRes="MR",nafo='all',main=2020)
 
 points(LATITUDE~LONGITUDE,subset(marf,YEAR==2020&NAFO=="4X"))
 points(LATITUDE~LONGITUDE,subset(marf,YEAR==2020&NAFO=="5Z"),col='blue')
 
 SpatialHub::bioMap("WSS", mapRes="MR",nafo='all',main=2019)
 
 points(LATITUDE~LONGITUDE,subset(marf,YEAR==2019&NAFO=="4X"))
 points(LATITUDE~LONGITUDE,subset(marf,YEAR==2019&NAFO=="5Z"),col='blue')
 
```

